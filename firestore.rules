rules_version = '2';

service cloud.firestore {
  match /databases/{db}/documents {

    /* ========= BASE ========= */
    
    // ========= HELPERS BASE =========
    function isAuth() { return request.auth != null; }
    function uid() { return request.auth.uid; }
    
    // Roles desde documento - CONTROL-STORE
    function controlStoreUserDocExists() {
      return isAuth() && exists(/databases/$(db)/documents/apps/control-store/users/$(uid()));
    }
    function controlStoreUserRole() {
      return isAuth() && controlStoreUserDocExists()
        ? get(/databases/$(db)/documents/apps/control-store/users/$(uid())).data.role
        : null;
    }
    
    // Roles desde documento - CONTROLREMITO (para otras apps)
    function userDocExists() {
      return isAuth() && exists(/databases/$(db)/documents/apps/controlRemito/users/$(uid()));
    }
    function userRole() {
      return isAuth() && userDocExists()
        ? get(/databases/$(db)/documents/apps/controlRemito/users/$(uid())).data.role
        : null;
    }
    
    function userBranchId() {
      return isAuth() && userDocExists()
        ? get(/databases/$(db)/documents/apps/controlRemito/users/$(uid())).data.branchId
        : null;
    }
    
    // Helpers para CONTROL-STORE
    function isControlStoreMaxDev() { return controlStoreUserRole() == 'maxdev'; }
    function isControlStoreAdmin()  { return controlStoreUserRole() == 'admin' || controlStoreUserRole() == 'maxdev'; }
    
    // Helpers para CONTROLREMITO y otras apps
    function isMaxDev() { return userRole() == 'maxdev'; }
    function isAdmin()  { return userRole() == 'admin' || userRole() == 'maxdev'; }
    function isFactory(){ return userRole() == 'factory'; }
    function isBranch() { return userRole() == 'branch'; }
    function isDelivery(){return userRole() == 'delivery'; }
    function isInvited() { return userRole() == 'invited'; }
    function isManager() { return userRole() == 'manager'; }
    
    // Operación y campos
    function isCreate() { return !exists(resource.path); }
    function isUpdate() { return exists(resource.path); }
    
    // Dueño por campo (e.g., userId/ownerId)
    function ownerIs(field) {
      return isAuth() && (
        (isCreate() && request.resource.data[field] == uid()) ||
        (isUpdate() && resource.data[field] == uid() && request.resource.data[field] == uid())
      );
    }
    
        // Inmutabilidad
        function unchanged(field) {
          return isUpdate() 
            ? (!(field in request.resource.data) || request.resource.data[field] == resource.data[field])
            : true;
        }
    
    // Inmutabilidad flexible - permite null/undefined
    function unchangedOrNull(field) {
      return isUpdate() 
        ? (
            // Si el campo existe en ambos, deben ser iguales
            (field in resource.data && field in request.resource.data && request.resource.data[field] == resource.data[field])
            // O si no existe en ninguno
            || (!(field in resource.data) && !(field in request.resource.data))
            // O si ambos son null
            || (resource.data[field] == null && request.resource.data[field] == null)
            // O si no existe en el original y es null en la actualización
            || (!(field in resource.data) && request.resource.data[field] == null)
            // O si es null en el original y no existe en la actualización
            || (resource.data[field] == null && !(field in request.resource.data))
          )
        : true;
    }
    
    // Tipos y validadores comunes
    function strBetween(field, min, max) {
      return request.resource.data[field] is string
          && request.resource.data[field].size() >= min
          && request.resource.data[field].size() <= max;
    }
    function nonEmptyString(field) {
      return request.resource.data[field] is string && request.resource.data[field].size() >= 1;
    }
    function isBool(field) { return request.resource.data[field] is bool; }
    function isInt(field) {
      return request.resource.data[field] is number
          && (request.resource.data[field] % 1) == 0;
    }
    function isTs(field) { return request.resource.data[field] is timestamp; }
    function isStringOrNull(field) {
      return !(field in request.resource.data) || request.resource.data[field] is string || request.resource.data[field] == null;
    }
    
    // Lectura pública por flag booleano del doc
    function publicRead(flagField) {
      return resource.data[flagField] == true;
    }
    
    

    /* ========= HORARIOS ========= */
    
    
    
        // =========================================================
        // =================== HELPERS GLOBALES ====================
        // =========================================================
    
    
    
        function userPath(userId) {
          return /databases/$(database)/documents/apps/horarios/users/$(userId);
        }
    
        function myUserPath() {
          return userPath(uid());
        }
    
        function hasMyUser() {
          return isAuth() && exists(myUserPath());
        }
    
        function myRoleIs(role) {
          return hasMyUser() && get(myUserPath()).data.role == role;
        }
    
    
    
        function myOwnerId() {
          return hasMyUser() && ('ownerId' in get(myUserPath()).data)
            ? get(myUserPath()).data.ownerId
            : '';
        }
    
        function invitedActingFor(ownerId) {
          return isInvited() && myOwnerId() == ownerId;
        }
    
        function canActFor(ownerId) {
          return isAuth() && (
            uid() == ownerId
            || isAdmin()
            || isManager()
            || isFactory()
            || invitedActingFor(ownerId)
          );
        }
    
        function protectFieldUnchanged(field) {
          return !(field in request.resource.data)
            || request.resource.data[field] == resource.data[field];
        }
    
        function protectUserId(resourceUserId) {
          return !('userId' in request.resource.data)
            || request.resource.data.userId == resourceUserId;
        }
    
        function protectCreatedBy() {
          return !('createdBy' in request.resource.data)
            || request.resource.data.createdBy == resource.data.createdBy;
        }
    
        function isParticipantArray(arr) {
          return (arr is list) && arr.hasAny([uid()]);
        }
    
        // =========================================================
        // ======================= USERS ===========================
        // =========================================================
        match /apps/horarios/users/{userId} {
          allow read: if isAuth() && (
            userId == uid()
            || isAdmin()
            || isManager()
            || isFactory()
          );
    
          allow create: if isAuth() && userId == uid();
    
          allow update: if isAuth() && (
            (userId == uid()
              && protectFieldUnchanged('role')
              && protectFieldUnchanged('uid'))
            || (isAdmin() && protectFieldUnchanged('uid'))
          );
    
          allow delete: if isAuth() && (userId == uid() || isAdmin());
        }
    
        // =========================================================
        // ======================= GROUPS ==========================
        // =========================================================
        match /apps/horarios/groups/{groupId} {
          allow read: if isAuth();
          allow create: if isAuth() && isAdmin();
    
          allow update: if isAuth() && (
            isAdmin()
            || (isManager()
              && ('managerId' in resource.data)
              && resource.data.managerId == uid()
              && protectFieldUnchanged('managerId'))
          );
    
          allow delete: if isAuth() && isAdmin();
        }
    
        // =========================================================
        // ====================== EMPLOYEES ========================
        // =========================================================
        match /apps/horarios/employees/{empleadoId} {
          allow read: if true;
    
          allow create: if isAuth()
            && request.resource.data.userId == uid();
    
          allow update: if isAuth()
            && canActFor(resource.data.userId)
            && protectUserId(resource.data.userId);
    
          allow delete: if isAuth()
            && (resource.data.userId == uid() || isAdmin());
        }
    
        // =========================================================
        // ======================= SHIFTS ==========================
        // =========================================================
        match /apps/horarios/shifts/{turnoId} {
          allow read: if true;
    
          allow create: if isAuth()
            && request.resource.data.userId == uid();
    
          allow update: if isAuth()
            && canActFor(resource.data.userId)
            && protectUserId(resource.data.userId);
    
          allow delete: if isAuth()
            && (resource.data.userId == uid() || isAdmin());
        }
    
        // =========================================================
        // ====================== SCHEDULES ========================
        // =========================================================
        match /apps/horarios/schedules/{horarioId} {
          allow read: if true;
    
          allow create: if isAuth()
            && request.resource.data.createdBy == uid();
    
          allow update: if isAuth()
            && (resource.data.createdBy == uid() || isAdmin())
            && protectCreatedBy();
    
          allow delete: if isAuth()
            && (resource.data.createdBy == uid() || isAdmin());
        }
    
        // =========================================================
        // ====================== HISTORIAL ========================
        // =========================================================
        match /apps/horarios/historial/{historialId} {
          allow read: if isAuth() && resource.data.createdBy == uid();
          allow create: if isAuth() && request.resource.data.createdBy == uid();
          allow update: if false;
          allow delete: if isAuth() && (resource.data.createdBy == uid() || isAdmin());
        }
    
        // =========================================================
        // ======================== CONFIG =========================
        // =========================================================
        match /apps/horarios/config/{configId} {
          allow read: if true;
          allow create, update: if isAuth() && configId == uid();
          allow delete: if false;
        }
    
        // =========================================================
        // ===================== INVITACIONES ======================
        // =========================================================
        match /apps/horarios/invitaciones/{invitacionId} {
          allow read: if true;
    
          allow create: if isAuth()
            && request.resource.data.ownerId == uid();
    
          allow update, delete: if isAuth()
            && (resource.data.ownerId == uid() || isAdmin());
        }
    
        // =========================================================
        // ======================= PEDIDOS =========================
        // =========================================================
        match /apps/horarios/pedidos/{pedidoId} {
          allow read: if true;
    
          allow create: if isAuth()
            && request.resource.data.userId == uid()
            && !isInvited();
    
          allow update: if isAuth()
            && canActFor(resource.data.userId)
            && protectUserId(resource.data.userId);
    
          allow delete: if isAuth()
            && (resource.data.userId == uid() || isAdmin());
        }
    
        // =========================================================
        // ======================= PRODUCTS ========================
        // =========================================================
        match /apps/horarios/products/{productoId} {
          allow read: if true;
    
          allow create: if isAuth()
            && (request.resource.data.userId == uid()
                || invitedActingFor(request.resource.data.userId));
    
          allow update: if isAuth()
            && canActFor(resource.data.userId)
            && protectUserId(resource.data.userId);
    
          allow delete: if isAuth()
            && (resource.data.userId == uid() || isAdmin());
        }
    
        // =========================================================
        // =================== STOCK MOVIMIENTOS ===================
        // =========================================================
        match /apps/horarios/stock_movimientos/{movimientoId} {
          allow read: if isAuth() && canActFor(resource.data.userId);
    
          allow create: if isAuth()
            && (request.resource.data.userId == uid()
                || invitedActingFor(request.resource.data.userId));
    
          allow update: if false;
    
          allow delete: if isAuth()
            && (resource.data.userId == uid() || isAdmin());
        }
    
        // =========================================================
        // ====================== STOCK ACTUAL =====================
        // =========================================================
        match /apps/horarios/stock_actual/{stockId} {
          allow read: if isAuth() && canActFor(resource.data.userId);
    
          allow create: if isAuth()
            && (request.resource.data.userId == uid()
                || invitedActingFor(request.resource.data.userId));
    
          allow update: if isAuth()
            && canActFor(resource.data.userId)
            && protectUserId(resource.data.userId);
    
          allow delete: if isAuth()
            && (resource.data.userId == uid() || isAdmin());
        }
    
        // =========================================================
        // ======================== REMITOS ========================
        // =========================================================
        match /apps/horarios/remitos/{remitoId} {
          allow read: if isAuth()
            && (canActFor(resource.data.userId) || isFactory());
    
          allow create: if isAuth()
            && (request.resource.data.userId == uid()
                || invitedActingFor(request.resource.data.userId)
                || isFactory()
                || isAdmin());
    
          allow update: if isAuth()
            && (canActFor(resource.data.userId) || isFactory())
            && protectUserId(resource.data.userId);
    
          allow delete: if isAuth()
            && (resource.data.userId == uid() || isAdmin() || isFactory());
        }
    
        // =========================================================
        // ======================= RECEPCIONES =====================
        // =========================================================
        match /apps/horarios/recepciones/{recepcionId} {
          allow read: if isAuth() && canActFor(resource.data.userId);
    
          allow create: if isAuth()
            && request.resource.data.userId == uid();
    
          allow update: if isAuth()
            && canActFor(resource.data.userId)
            && protectUserId(resource.data.userId);
    
          allow delete: if isAuth()
            && (resource.data.userId == uid() || isAdmin());
        }
    
        // =========================================================
        // ==================== ENLACES PUBLICOS ===================
        // =========================================================
        match /apps/horarios/enlaces_publicos/{enlaceId} {
          allow read: if true;
    
          allow create: if isAuth()
            && (request.resource.data.userId == uid()
                || invitedActingFor(request.resource.data.userId)
                || isAdmin());
    
          allow update: if isAuth()
            && (canActFor(resource.data.userId) || isFactory())
            && protectUserId(resource.data.userId);
    
          allow delete: if isAuth()
            && (resource.data.userId == uid() || isAdmin());
        }
    
        // =========================================================
        // ===================== CONVERSACIONES ====================
        // =========================================================
        match /apps/horarios/conversaciones/{conversacionId} {
          function canAccessConversation() {
            return resource.data != null
              && ('participantes' in resource.data)
              && isParticipantArray(resource.data.participantes);
          }
    
          allow read: if isAuth() && canAccessConversation();
    
          allow create: if isAuth()
            && ('participantes' in request.resource.data)
            && isParticipantArray(request.resource.data.participantes);
    
          allow update, delete: if isAuth() && canAccessConversation();
        }
    
        // =========================================================
        // ======================== MENSAJES =======================
        // =========================================================
        match /apps/horarios/mensajes/{mensajeId} {
          function canAccessConvId(convId) {
            return exists(/databases/$(database)/documents/apps/horarios/conversaciones/$(convId))
              && ('participantes' in get(/databases/$(database)/documents/apps/horarios/conversaciones/$(convId)).data)
              && isParticipantArray(
                   get(/databases/$(database)/documents/apps/horarios/conversaciones/$(convId)).data.participantes
                 );
          }
    
          allow read: if isAuth()
            && canAccessConvId(resource.data.conversacionId);
    
          allow create: if isAuth()
            && request.resource.data.remitenteId == uid()
            && canAccessConvId(request.resource.data.conversacionId);
    
          allow update: if isAuth()
            && canAccessConvId(resource.data.conversacionId)
            && protectFieldUnchanged('remitenteId')
            && protectFieldUnchanged('contenido')
            && protectFieldUnchanged('conversacionId');
    
          allow delete: if isAuth()
            && (resource.data.remitenteId == uid() || isAdmin());
        }
    // =========================================================
    // ============ EMPLOYEE FIXED RULES (HORARIOS FIJOS) ======
    // =========================================================
    match /apps/horarios/employee_fixed_rules/{ruleId} {
    
      // Lectura:
      // - cualquiera autenticado que pueda actuar para el owner
      allow read: if isAuth()
        && canActFor(resource.data.ownerId);
    
      // Creación:
      allow create: if isAuth()
        // owner correcto
        && request.resource.data.ownerId == myOwnerId()
        // usuario creador correcto
        && request.resource.data.createdBy == uid()
        // employeeId obligatorio
        && ('employeeId' in request.resource.data)
        // día válido
        && request.resource.data.dayOfWeek >= 0
        && request.resource.data.dayOfWeek <= 6;
    
      // Actualización:
      allow update: if isAuth()
        && canActFor(resource.data.ownerId)
        // no permitir cambiar owner
        && protectFieldUnchanged('ownerId')
        // no permitir cambiar empleado
        && protectFieldUnchanged('employeeId')
        // no permitir cambiar creador
        && protectCreatedBy();
    
      // Eliminación:
      allow delete: if isAuth()
        && canActFor(resource.data.ownerId);
    }
    // =========================================================
    // ================= EMPLOYEE REQUESTS =====================
    // =========================================================
    match /apps/horarios/employee_requests/{requestId} {
    
      // Lectura:
      // - empleado autenticado
      // - roles con acceso (admin / manager / factory / invitado)
      // IMPORTANTE: NO usar resource.data en read (queries)
      allow read: if isAuth();
    
      // Creación:
      // - solo el empleado autenticado
      allow create: if isAuth()
        && request.resource.data.userId == uid()
        && request.resource.data.ownerId == myOwnerId();
    
      // Update:
      // - owner / admin / manager
      // - el empleado NO puede editar una vez creada
      allow update: if isAuth()
        && canActFor(resource.data.ownerId)
        && protectFieldUnchanged('userId')
        && protectFieldUnchanged('employeeId')
        && protectFieldUnchanged('ownerId');
    
      // Delete:
      // - owner o admin
      allow delete: if isAuth()
        && canActFor(resource.data.ownerId);
    }
    
    // =========================================================
    // ============== CALENDAR SPECIAL DAYS ====================
    // =========================================================
    match /apps/horarios/calendarSpecialDays/{specialDayId} {
    
      // Lectura:
      // - cualquier usuario autenticado puede leer (datos públicos de feriados)
      // - información útil para generación de horarios
      allow read: if isAuth();
    
      // Creación:
      // - admin o manager pueden crear días especiales
      // - usuarios invitados pueden crear locales solo para su owner
      allow create: if isAuth()
        // admin/manager pueden crear cualquier día especial
        && (isAdmin() || isManager())
        // o invitados pueden crear días locales para su owner
        || (isInvited()
            && request.resource.data.source == 'manual'
            && request.resource.data.scope in ['municipal', 'provincial']
            && request.resource.data.ownerId == myOwnerId())
        // validaciones de datos
        && validSpecialDayData(request.resource.data);
    
      // Actualización:
      // - admin/manager pueden actualizar cualquier día especial
      // - invitados pueden actualizar solo días manuales y locales
      allow update: if isAuth()
        // admin/manager pueden actualizar cualquier día
        && (isAdmin() || isManager())
        // o invitados pueden actualizar días manuales locales/provinciales
        || (isInvited()
            && resource.data.source == 'manual'
            && resource.data.scope in ['municipal', 'provincial']
            && resource.data.ownerId == myOwnerId())
        // no permitir cambiar ID ni fecha (clave del documento)
        && protectFieldUnchanged('date')
        && protectFieldUnchanged('city')
        // validaciones de datos
        && validSpecialDayData(request.resource.data);
    
      // Eliminación:
      // - solo admin/manager pueden eliminar
      // - invitados pueden eliminar solo días manuales que crearon
      allow delete: if isAuth()
        // admin/manager pueden eliminar cualquier día
        && (isAdmin() || isManager())
        // o invitados pueden eliminar días manuales locales/provinciales
        || (isInvited()
            && resource.data.source == 'manual'
            && resource.data.scope in ['municipal', 'provincial']
            && resource.data.ownerId == myOwnerId());
    }
    
    // Validador de datos para días especiales
    function validSpecialDayData(data) {
      return data.keys().hasAll([
        'date', 'city', 'province', 'country', 
        'title', 'type', 'scope', 'severity', 
        'affectsScheduling', 'source'
      ])
      // fecha en formato YYYY-MM-DD
      && data.date is string
      && data.date.matches('^[0-9]{4}-[0-9]{2}-[0-9]{2}$')
      // campos de texto obligatorios
      && data.city is string
      && data.city.size() > 0
      && data.province is string
      && data.province.size() > 0
      && data.country is string
      && data.country.size() > 0
      && data.title is string
      && data.title.size() > 0
      // tipo y alcance válidos
      && data.type in ['feriado', 'no_laborable', 'local', 'evento']
      && data.scope in ['nacional', 'provincial', 'municipal']
      && data.severity in ['info', 'warning', 'critical']
      // booleanos
      && data.affectsScheduling is bool
      && data.source in ['api', 'manual']
      // descripción opcional
      && (!('description' in data) || data.description is string)
      // timestamps
      && data.createdAt is timestamp
      && data.updatedAt is timestamp;
    }
    
        // =========================================================
        // ===================== DEFAULT DENY ======================
        // =========================================================
        match /{document=**} {
          allow read, write: if false;
        }
    

    /* ========= DENY POR DEFECTO ========= */

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
