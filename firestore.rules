rules_version = '2';

service cloud.firestore {
  match /databases/{db}/documents {

    /* ========= BASE ========= */
    
    // ========= HELPERS BASE =========
    function isAuth() { return request.auth != null; }
    function uid() { return request.auth.uid; }
    
    // Roles desde documento - CONTROL-STORE
    function controlStoreUserDocExists() {
      return isAuth() && exists(/databases/$(db)/documents/apps/control-store/users/$(uid()));
    }
    function controlStoreUserRole() {
      return isAuth() && controlStoreUserDocExists()
        ? get(/databases/$(db)/documents/apps/control-store/users/$(uid())).data.role
        : null;
    }
    
    // Roles desde documento - CONTROLREMITO (para otras apps)
    function userDocExists() {
      return isAuth() && exists(/databases/$(db)/documents/apps/controlRemito/users/$(uid()));
    }
    function userRole() {
      return isAuth() && userDocExists()
        ? get(/databases/$(db)/documents/apps/controlRemito/users/$(uid())).data.role
        : null;
    }
    
    function userBranchId() {
      return isAuth() && userDocExists()
        ? get(/databases/$(db)/documents/apps/controlRemito/users/$(uid())).data.branchId
        : null;
    }
    
    // Helpers para CONTROL-STORE
    function isControlStoreMaxDev() { return controlStoreUserRole() == 'maxdev'; }
    function isControlStoreAdmin()  { return controlStoreUserRole() == 'admin' || controlStoreUserRole() == 'maxdev'; }
    
    // Helpers para CONTROLREMITO y otras apps
    function isMaxDev() { return userRole() == 'maxdev'; }
    function isAdmin()  { return userRole() == 'admin' || userRole() == 'maxdev'; }
    function isFactory(){ return userRole() == 'factory'; }
    function isBranch() { return userRole() == 'branch'; }
    function isDelivery(){return userRole() == 'delivery'; }
    
    // Operación y campos
    function isCreate() { return !exists(resource.path); }
    function isUpdate() { return exists(resource.path); }
    
    // Dueño por campo (e.g., userId/ownerId)
    function ownerIs(field) {
      return isAuth() && (
        (isCreate() && request.resource.data[field] == uid()) ||
        (isUpdate() && resource.data[field] == uid() && request.resource.data[field] == uid())
      );
    }
    
        // Inmutabilidad
        function unchanged(field) {
          return isUpdate() 
            ? (!(field in request.resource.data) || request.resource.data[field] == resource.data[field])
            : true;
        }
    
    // Inmutabilidad flexible - permite null/undefined
    function unchangedOrNull(field) {
      return isUpdate() 
        ? (
            // Si el campo existe en ambos, deben ser iguales
            (field in resource.data && field in request.resource.data && request.resource.data[field] == resource.data[field])
            // O si no existe en ninguno
            || (!(field in resource.data) && !(field in request.resource.data))
            // O si ambos son null
            || (resource.data[field] == null && request.resource.data[field] == null)
            // O si no existe en el original y es null en la actualización
            || (!(field in resource.data) && request.resource.data[field] == null)
            // O si es null en el original y no existe en la actualización
            || (resource.data[field] == null && !(field in request.resource.data))
          )
        : true;
    }
    
    // Tipos y validadores comunes
    function strBetween(field, min, max) {
      return request.resource.data[field] is string
          && request.resource.data[field].size() >= min
          && request.resource.data[field].size() <= max;
    }
    function nonEmptyString(field) {
      return request.resource.data[field] is string && request.resource.data[field].size() >= 1;
    }
    function isBool(field) { return request.resource.data[field] is bool; }
    function isInt(field) {
      return request.resource.data[field] is number
          && (request.resource.data[field] % 1) == 0;
    }
    function isTs(field) { return request.resource.data[field] is timestamp; }
    function isStringOrNull(field) {
      return !(field in request.resource.data) || request.resource.data[field] is string || request.resource.data[field] == null;
    }
    
    // Helper para validar campos que pueden ser string, null, o eliminados (no presentes)
    function isStringOrNullOrMissing(field) {
      return !(field in request.resource.data) || request.resource.data[field] is string || request.resource.data[field] == null;
    }
    
    // Lectura pública por flag booleano del doc
    function publicRead(flagField) {
      return resource.data[flagField] == true;
    }
    
    

    /* ========= HORARIOS ========= */
    
    // ========= HORARIOS SCHEDULER =========
    
    // Helper para verificar que el usuario tiene documento en apps/horarios/users
    function horariosUserDocExists() {
      return isAuth() && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()));
    }
    
    // Colección: apps/horarios/users
    match /apps/horarios/users/{userId} {
      allow read: if isAuth() && uid() == userId;
      allow create: if isAuth() && uid() == userId
        && nonEmptyString('uid')
        && request.resource.data.uid == uid()
        && isStringOrNull('email')
        && isStringOrNull('displayName')
        && isStringOrNull('photoURL')
        && isStringOrNull('role')
        && isTs('createdAt')
        && isTs('updatedAt');
      allow update: if isAuth() && uid() == userId
        && unchanged('uid')
        && isStringOrNull('email')
        && isStringOrNull('displayName')
        && isStringOrNull('photoURL')
        && isStringOrNull('role')
        && unchanged('createdAt');
      allow delete: if false; // No permitir eliminar usuarios
    }
    
    // Colección: apps/horarios/employees
    match /apps/horarios/employees/{empleadoId} {
      allow read: if isAuth() && resource.data.userId == uid();
      allow create: if isAuth()
        && nonEmptyString('name')
        && nonEmptyString('userId')
        && request.resource.data.userId == uid()
            && isStringOrNull('email')
            && isStringOrNull('phone')
            && isTs('createdAt')
        && isTs('updatedAt');
      allow update: if isAuth()
        && resource.data.userId == uid()
        && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId)
        && (!('name' in request.resource.data) || (request.resource.data.name is string && request.resource.data.name.size() >= 1))
        && (!('email' in request.resource.data) || request.resource.data.email is string || request.resource.data.email == null)
        && (!('phone' in request.resource.data) || request.resource.data.phone is string || request.resource.data.phone == null)
        && unchanged('createdAt');
      allow delete: if isAuth() && resource.data.userId == uid();
    }
    
    // Colección: apps/horarios/shifts
    match /apps/horarios/shifts/{turnoId} {
      allow read: if isAuth() && resource.data.userId == uid();
      allow create: if isAuth()
        && nonEmptyString('name')
        && nonEmptyString('userId')
        && request.resource.data.userId == uid()
        && isStringOrNull('startTime')
        && isStringOrNull('endTime')
        && isStringOrNull('startTime2')
        && isStringOrNull('endTime2')
        && nonEmptyString('color')
        && isTs('createdAt')
        && isTs('updatedAt');
      // Regla simplificada: solo verifica que el usuario es el dueño
      allow update: if isAuth() && resource.data.userId == uid();
      allow delete: if isAuth() && resource.data.userId == uid();
    }
    
    // Colección: apps/horarios/schedules
    match /apps/horarios/schedules/{horarioId} {
      allow read: if isAuth();
      allow create: if isAuth()
        && nonEmptyString('nombre')
        && nonEmptyString('weekStart')
        && nonEmptyString('semanaInicio')
        && nonEmptyString('semanaFin')
        && request.resource.data.assignments is map
        && isTs('createdAt')
        && isTs('updatedAt')
        && (isStringOrNull('createdBy') || request.resource.data.createdBy == uid())
        && isStringOrNull('createdByName')
        && isStringOrNull('modifiedBy')
        && isStringOrNull('modifiedByName')
        && (request.resource.data.completada == null || request.resource.data.completada is bool)
        && (request.resource.data.completadaPor == null || request.resource.data.completadaPor is string)
        && (request.resource.data.completadaPorNombre == null || request.resource.data.completadaPorNombre is string)
        && (request.resource.data.completadaEn == null || request.resource.data.completadaEn is timestamp);
      allow update: if isAuth()
        && (!('nombre' in request.resource.data) || nonEmptyString('nombre'))
        && (!('weekStart' in request.resource.data) || nonEmptyString('weekStart'))
        && (!('semanaInicio' in request.resource.data) || nonEmptyString('semanaInicio'))
        && (!('semanaFin' in request.resource.data) || nonEmptyString('semanaFin'))
        && (!('assignments' in request.resource.data) || request.resource.data.assignments is map)
        && (!('modifiedBy' in request.resource.data) || isStringOrNull('modifiedBy'))
        && (!('modifiedByName' in request.resource.data) || isStringOrNull('modifiedByName'))
        && (!('completada' in request.resource.data) || request.resource.data.completada is bool)
        && (!('completadaPor' in request.resource.data) || request.resource.data.completadaPor is string || request.resource.data.completadaPor == null)
        && (!('completadaPorNombre' in request.resource.data) || request.resource.data.completadaPorNombre is string || request.resource.data.completadaPorNombre == null)
        && (!('completadaEn' in request.resource.data) || request.resource.data.completadaEn is timestamp || request.resource.data.completadaEn == null)
        && (!('updatedAt' in request.resource.data) || request.resource.data.updatedAt is timestamp)
        && (!('createdAt' in request.resource.data) || request.resource.data.createdAt is timestamp)
        && (!('createdBy' in request.resource.data) || isStringOrNull('createdBy'))
        && (!('createdByName' in request.resource.data) || isStringOrNull('createdByName'));
      allow delete: if isAuth();
    }
    
    // Colección: apps/horarios/historial
    match /apps/horarios/historial/{historialId} {
      allow read: if isAuth();
      allow create: if isAuth()
        && nonEmptyString('horarioId')
        && nonEmptyString('nombre')
        && nonEmptyString('semanaInicio')
        && nonEmptyString('semanaFin')
        && request.resource.data.assignments is map
        && (request.resource.data.accion == 'creado' || request.resource.data.accion == 'modificado')
        && isTs('createdAt')
        && (isStringOrNull('createdBy') || request.resource.data.createdBy == uid())
        && isStringOrNull('createdByName')
        && (isBool('versionAnterior') || !('versionAnterior' in request.resource.data));
      allow update: if false; // Historial es inmutable
      allow delete: if isAuth();
    }
    
    // Colección: apps/horarios/config
    match /apps/horarios/config/{configId} {
      // Permitir lectura a cualquier usuario autenticado
      allow read: if isAuth();
      // Permitir crear/actualizar a cualquier usuario autenticado
      allow create, update: if isAuth();
      allow delete: if false; // No permitir eliminar configuración
    }
    
    

    /* ========= DENY POR DEFECTO ========= */

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
