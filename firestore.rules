rules_version = '2';

service cloud.firestore {
  match /databases/{db}/documents {

    /* ========= BASE ========= */
    
    // ========= HELPERS BASE =========
    function isAuth() { return request.auth != null; }
    function uid() { return request.auth.uid; }
    
    // Roles desde documento - CONTROL-STORE
    function controlStoreUserDocExists() {
      return isAuth() && exists(/databases/$(db)/documents/apps/control-store/users/$(uid()));
    }
    function controlStoreUserRole() {
      return isAuth() && controlStoreUserDocExists()
        ? get(/databases/$(db)/documents/apps/control-store/users/$(uid())).data.role
        : null;
    }
    
    // Roles desde documento - CONTROLREMITO (para otras apps)
    function userDocExists() {
      return isAuth() && exists(/databases/$(db)/documents/apps/controlRemito/users/$(uid()));
    }
    function userRole() {
      return isAuth() && userDocExists()
        ? get(/databases/$(db)/documents/apps/controlRemito/users/$(uid())).data.role
        : null;
    }
    
    function userBranchId() {
      return isAuth() && userDocExists()
        ? get(/databases/$(db)/documents/apps/controlRemito/users/$(uid())).data.branchId
        : null;
    }
    
    // Helpers para CONTROL-STORE
    function isControlStoreMaxDev() { return controlStoreUserRole() == 'maxdev'; }
    function isControlStoreAdmin()  { return controlStoreUserRole() == 'admin' || controlStoreUserRole() == 'maxdev'; }
    
    // Helpers para CONTROLREMITO y otras apps
    function isMaxDev() { return userRole() == 'maxdev'; }
    function isAdmin()  { return userRole() == 'admin' || userRole() == 'maxdev'; }
    function isFactory(){ return userRole() == 'factory'; }
    function isBranch() { return userRole() == 'branch'; }
    function isDelivery(){return userRole() == 'delivery'; }
    
    // Operación y campos
    function isCreate() { return !exists(resource.path); }
    function isUpdate() { return exists(resource.path); }
    
    // Dueño por campo (e.g., userId/ownerId)
    function ownerIs(field) {
      return isAuth() && (
        (isCreate() && request.resource.data[field] == uid()) ||
        (isUpdate() && resource.data[field] == uid() && request.resource.data[field] == uid())
      );
    }
    
        // Inmutabilidad
        function unchanged(field) {
          return isUpdate() 
            ? (!(field in request.resource.data) || request.resource.data[field] == resource.data[field])
            : true;
        }
    
    // Inmutabilidad flexible - permite null/undefined
    function unchangedOrNull(field) {
      return isUpdate() 
        ? (
            // Si el campo existe en ambos, deben ser iguales
            (field in resource.data && field in request.resource.data && request.resource.data[field] == resource.data[field])
            // O si no existe en ninguno
            || (!(field in resource.data) && !(field in request.resource.data))
            // O si ambos son null
            || (resource.data[field] == null && request.resource.data[field] == null)
            // O si no existe en el original y es null en la actualización
            || (!(field in resource.data) && request.resource.data[field] == null)
            // O si es null en el original y no existe en la actualización
            || (resource.data[field] == null && !(field in request.resource.data))
          )
        : true;
    }
    
    // Tipos y validadores comunes
    function strBetween(field, min, max) {
      return request.resource.data[field] is string
          && request.resource.data[field].size() >= min
          && request.resource.data[field].size() <= max;
    }
    function nonEmptyString(field) {
      return request.resource.data[field] is string && request.resource.data[field].size() >= 1;
    }
    function isBool(field) { return request.resource.data[field] is bool; }
    function isInt(field) {
      return request.resource.data[field] is number
          && (request.resource.data[field] % 1) == 0;
    }
    function isTs(field) { return request.resource.data[field] is timestamp; }
    function isStringOrNull(field) {
      return !(field in request.resource.data) || request.resource.data[field] is string || request.resource.data[field] == null;
    }
    
    // Lectura pública por flag booleano del doc
    function publicRead(flagField) {
      return resource.data[flagField] == true;
    }
    
    // Helper para verificar si un pedido puede ser actualizado sin autenticación
    function pedidoPuedeActualizarseSinAuth() {
      return !('estado' in resource.data) 
        || resource.data.estado == null
        || (resource.data.estado != "enviado" 
            && resource.data.estado != "recibido" 
            && resource.data.estado != "completado");
    }
    
    

    /* ========= HORARIOS ========= */
    
    // ========= HORARIOS SCHEDULER =========
    
    // Colección: apps/horarios/users
    match /apps/horarios/users/{userId} {
      // Solo el usuario puede leer su propio documento
      allow read: if isAuth() && userId == uid();
      // Crear: el usuario puede crear su propio documento
      allow create: if isAuth() && userId == uid();
      // Actualizar: el usuario puede actualizar su propio documento
      // Si el campo uid existe, no debe cambiar; si no existe, se puede agregar
      allow update: if isAuth() && userId == uid() && (
        !('uid' in resource.data) || 
        !('uid' in request.resource.data) || 
        request.resource.data.uid == resource.data.uid
      );
      // Eliminar: 
      // - El usuario puede eliminar su propio documento
      // - El dueño puede eliminar usuarios invitados vinculados a sus invitaciones
      allow delete: if isAuth() && (
        userId == uid()
        || (exists(/databases/$(db)/documents/apps/horarios/users/$(userId))
          && get(/databases/$(db)/documents/apps/horarios/users/$(userId)).data.role == 'invited'
          && get(/databases/$(db)/documents/apps/horarios/users/$(userId)).data.ownerId == uid())
      );
    }
    
    // Colección: apps/horarios/employees
    match /apps/horarios/employees/{empleadoId} {
      // Permitir lectura pública (para página compartible)
      allow read: if true;
      // Crear: verificar que userId sea correcto
      allow create: if isAuth() && request.resource.data.userId == uid();
      // Actualizar: verificar propiedad y proteger userId
      allow update: if isAuth() && resource.data.userId == uid()
        && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId);
      // Eliminar: solo el dueño
      allow delete: if isAuth() && resource.data.userId == uid();
    }
    
    // Colección: apps/horarios/shifts
    match /apps/horarios/shifts/{turnoId} {
      // Permitir lectura pública (para página compartible)
      allow read: if true;
      // Crear: verificar que userId sea correcto
      allow create: if isAuth() && request.resource.data.userId == uid();
      // Actualizar: verificar propiedad y proteger userId
      allow update: if isAuth() && resource.data.userId == uid()
        && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId);
      // Eliminar: solo el dueño
      allow delete: if isAuth() && resource.data.userId == uid();
    }
    
    // Colección: apps/horarios/schedules
    match /apps/horarios/schedules/{horarioId} {
      // Permitir lectura pública (para página compartible)
      allow read: if true;
      // Crear: verificar que createdBy sea correcto
      allow create: if isAuth() && request.resource.data.createdBy == uid();
      // Actualizar: verificar propiedad y proteger createdBy
      allow update: if isAuth() && resource.data.createdBy == uid()
        && (!('createdBy' in request.resource.data) || request.resource.data.createdBy == resource.data.createdBy);
      // Eliminar: solo el dueño
      allow delete: if isAuth() && resource.data.createdBy == uid();
    }
    
    // Colección: apps/horarios/historial
    match /apps/horarios/historial/{historialId} {
      // Solo el dueño puede leer
      allow read: if isAuth() && resource.data.createdBy == uid();
      // Crear: verificar que createdBy sea correcto
      allow create: if isAuth() && request.resource.data.createdBy == uid();
      // Historial es inmutable
      allow update: if false;
      // Eliminar: solo el dueño
      allow delete: if isAuth() && resource.data.createdBy == uid();
    }
    
    // Colección: apps/horarios/config
    match /apps/horarios/config/{configId} {
      // Permitir lectura pública (para página compartible)
      allow read: if true;
      // Solo el usuario puede editar su propia configuración (configId debe ser su uid)
      allow write: if isAuth() && configId == uid();
      // No permitir eliminar configuración
      allow delete: if false;
    }
    
    // Colección: apps/horarios/invitaciones
    match /apps/horarios/invitaciones/{invitacionId} {
      // Permitir lectura sin autenticación para validar tokens en registro
      allow read: if true;
      // El dueño puede crear invitaciones
      allow create: if isAuth() && request.resource.data.ownerId == uid();
      // Actualizar:
      // - El dueño puede actualizar cualquier cosa
      // - Cualquier usuario autenticado puede marcar como usada (protegiendo campos sensibles)
      allow update: if isAuth() && (
        // El ownerId puede hacer cualquier actualización
        resource.data.ownerId == uid()
        // O cualquier usuario autenticado puede marcar como usada
        || (
          // Solo si la invitación no está ya usada
          (resource.data.usado == null || resource.data.usado == false || !('usado' in resource.data))
          // Proteger campos sensibles (no se pueden cambiar)
          && (!('ownerId' in request.resource.data) || request.resource.data.ownerId == resource.data.ownerId)
          && (!('token' in request.resource.data) || request.resource.data.token == resource.data.token)
          && (!('activo' in request.resource.data) || request.resource.data.activo == resource.data.activo)
        )
      );
      // Eliminar: solo el dueño puede eliminar sus invitaciones
      allow delete: if isAuth() && resource.data.ownerId == uid();
    }

    // Colección: apps/horarios/pedidos
    match /apps/horarios/pedidos/{pedidoId} {
      // Permitir lectura si es el dueño O si es un usuario invitado del dueño O si no hay autenticación
      allow read: if (isAuth() && resource.data.userId == uid()) 
        || (isAuth() && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
          && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role == 'invited'
          && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId == resource.data.userId)
        || !isAuth();
      // Crear: verificar que userId sea correcto (solo dueños pueden crear)
      allow create: if isAuth() && request.resource.data.userId == uid()
        && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
        && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role != 'invited';
      // Actualizar: 
      // - Si está autenticado como dueño: verificar propiedad y proteger userId
      // - Si está autenticado como invitado: permitir actualizar si el pedido pertenece a su ownerId
      // - Si NO está autenticado: permitir solo si el pedido NO está en estado "enviado", "recibido" o "completado"
      allow update: if (isAuth() && resource.data.userId == uid()
        && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId))
        || (isAuth() 
          && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
          && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role == 'invited'
          && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId == resource.data.userId
          && pedidoPuedeActualizarseSinAuth()
          && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId))
        || (!isAuth() 
          && pedidoPuedeActualizarseSinAuth()
          && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId)
          // Solo permitir actualizar campos específicos: estado, remitoEnvioId, fechaEnvio, updatedAt
          && (!('nombre' in request.resource.data) || request.resource.data.nombre == resource.data.nombre)
          && (!('stockMinimoDefault' in request.resource.data) || request.resource.data.stockMinimoDefault == resource.data.stockMinimoDefault)
          && (!('formatoSalida' in request.resource.data) || request.resource.data.formatoSalida == resource.data.formatoSalida)
          && (!('mensajePrevio' in request.resource.data) || request.resource.data.mensajePrevio == resource.data.mensajePrevio)
          && (!('origenDefault' in request.resource.data) || request.resource.data.origenDefault == resource.data.origenDefault)
          && (!('destinoDefault' in request.resource.data) || request.resource.data.destinoDefault == resource.data.destinoDefault)
          && (!('fechaRecepcion' in request.resource.data) || request.resource.data.fechaRecepcion == resource.data.fechaRecepcion)
          && (!('createdAt' in request.resource.data) || request.resource.data.createdAt == resource.data.createdAt));
      // Eliminar: solo el dueño (no invitados)
      allow delete: if isAuth() && resource.data.userId == uid()
        && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
        && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role != 'invited';
    }
    
    // Colección: apps/horarios/products
    match /apps/horarios/products/{productoId} {
      // Permitir lectura si es el dueño O si es un usuario invitado del dueño O si no hay autenticación
      allow read: if (isAuth() && resource.data.userId == uid()) 
        || (isAuth() && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
          && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role == 'invited'
          && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId == resource.data.userId)
        || !isAuth();
      // Crear: verificar que userId sea correcto (invitados pueden crear productos con ownerId)
      allow create: if isAuth() && (
        (request.resource.data.userId == uid() && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
          && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role != 'invited')
        || (exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
          && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role == 'invited'
          && request.resource.data.userId == get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId)
      );
      // Actualizar: verificar propiedad y proteger userId (invitados pueden actualizar productos del ownerId)
      allow update: if (isAuth() && resource.data.userId == uid()
        && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId))
        || (isAuth() 
          && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
          && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role == 'invited'
          && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId == resource.data.userId
          && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId));
      // Eliminar: solo el dueño (no invitados)
      allow delete: if isAuth() && resource.data.userId == uid()
        && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
        && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role != 'invited';
    }
    
    // Colección: apps/horarios/remitos
    match /apps/horarios/remitos/{remitoId} {
      // Permitir lectura si es el dueño O si es un usuario invitado del dueño
      allow read: if isAuth() && (
        resource.data.userId == uid()
        || (exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
          && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role == 'invited'
          && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId == resource.data.userId)
      );
      // Crear: 
      // - Si está autenticado: verificar que userId sea correcto
      // - Si NO está autenticado: permitir solo si el pedido existe y el userId coincide
      //   (la aplicación controla que el pedido esté en estado válido antes de crear el remito)
      allow create: if (isAuth() && request.resource.data.userId == uid())
        || (!isAuth() 
          && request.resource.data.pedidoId != null
          && exists(/databases/$(db)/documents/apps/horarios/pedidos/$(request.resource.data.pedidoId))
          && request.resource.data.userId == get(/databases/$(db)/documents/apps/horarios/pedidos/$(request.resource.data.pedidoId)).data.userId);
      // Actualizar: verificar propiedad y proteger userId
      allow update: if isAuth() && resource.data.userId == uid()
        && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId);
      // Eliminar: solo el dueño
      allow delete: if isAuth() && resource.data.userId == uid();
    }
    
    // Colección: apps/horarios/recepciones
    match /apps/horarios/recepciones/{recepcionId} {
      // Solo el dueño puede leer sus recepciones
      allow read: if isAuth() && resource.data.userId == uid();
      // Crear: verificar que userId sea correcto
      allow create: if isAuth() && request.resource.data.userId == uid();
      // Actualizar: verificar propiedad y proteger userId
      allow update: if isAuth() && resource.data.userId == uid()
        && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId);
      // Eliminar: solo el dueño
      allow delete: if isAuth() && resource.data.userId == uid();
    }
    
    // Colección: apps/horarios/enlaces_publicos
    match /apps/horarios/enlaces_publicos/{enlaceId} {
      // Permitir lectura pública (para que la fábrica pueda acceder sin login)
      allow read: if true;
      // Crear: verificar que userId sea correcto (la app debe incluir userId al crear)
      allow create: if isAuth() && request.resource.data.userId == uid();
      // Actualizar: 
      // - Si está autenticado: verificar propiedad y proteger userId
      // - Si NO está autenticado: permitir actualizar cuando está activo
      //   - Proteger campos sensibles (userId, pedidoId, createdAt)
      //   - Permitir actualizar productosDisponibles, fechaAcceso
      //   - Permitir desactivar solo si el pedido está enviado
      allow update: if (isAuth() && resource.data.userId == uid()
        && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId))
        || (!isAuth() 
          && resource.data.activo == true
          // Proteger campos sensibles
          && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId)
          && (!('pedidoId' in request.resource.data) || request.resource.data.pedidoId == resource.data.pedidoId)
          && (!('createdAt' in request.resource.data) || request.resource.data.createdAt == resource.data.createdAt)
          && (
            // Caso 1: No se modifica activo o no está en request - permitir actualizar
            (!('activo' in request.resource.data) || request.resource.data.activo == true)
            // Caso 2: Se intenta desactivar - solo si el pedido está enviado
            || (request.resource.data.activo == false
              && exists(/databases/$(db)/documents/apps/horarios/pedidos/$(resource.data.pedidoId))
              && get(/databases/$(db)/documents/apps/horarios/pedidos/$(resource.data.pedidoId)).data.estado == "enviado")
          ));
      // Eliminar: solo el dueño
      allow delete: if isAuth() && resource.data.userId == uid();
    }
    

    /* ========= DENY POR DEFECTO ========= */

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
