

    // =========================================================
    // =================== HELPERS GLOBALES ====================
    // =========================================================

   

    function userPath(userId) {
      return /databases/$(database)/documents/apps/horarios/users/$(userId);
    }

    function myUserPath() {
      return userPath(uid());
    }

    function hasMyUser() {
      return isAuth() && exists(myUserPath());
    }

    function myRoleIs(role) {
      return hasMyUser() && get(myUserPath()).data.role == role;
    }

  

    function myOwnerId() {
      return hasMyUser() && ('ownerId' in get(myUserPath()).data)
        ? get(myUserPath()).data.ownerId
        : '';
    }

    function invitedActingFor(ownerId) {
      return isInvited() && myOwnerId() == ownerId;
    }

    function canActFor(ownerId) {
      return isAuth() && (
        uid() == ownerId
        || isAdmin()
        || isManager()
        || isFactory()
        || invitedActingFor(ownerId)
      );
    }

    function protectFieldUnchanged(field) {
      return !(field in request.resource.data)
        || request.resource.data[field] == resource.data[field];
    }

    function protectUserId(resourceUserId) {
      return !('userId' in request.resource.data)
        || request.resource.data.userId == resourceUserId;
    }

    function protectCreatedBy() {
      return !('createdBy' in request.resource.data)
        || request.resource.data.createdBy == resource.data.createdBy;
    }

    function isParticipantArray(arr) {
      return (arr is list) && arr.hasAny([uid()]);
    }

    // =========================================================
    // ======================= USERS ===========================
    // =========================================================
    match /apps/horarios/users/{userId} {
      allow read: if isAuth() && (
        userId == uid()
        || isAdmin()
        || isManager()
        || isFactory()
      );

      allow create: if isAuth() && userId == uid();

      allow update: if isAuth() && (
        (userId == uid()
          && protectFieldUnchanged('role')
          && protectFieldUnchanged('uid'))
        || (isAdmin() && protectFieldUnchanged('uid'))
      );

      allow delete: if isAuth() && (userId == uid() || isAdmin());
    }

    // =========================================================
    // ======================= GROUPS ==========================
    // =========================================================
    match /apps/horarios/groups/{groupId} {
      allow read: if isAuth();
      allow create: if isAuth() && isAdmin();

      allow update: if isAuth() && (
        isAdmin()
        || (isManager()
          && ('managerId' in resource.data)
          && resource.data.managerId == uid()
          && protectFieldUnchanged('managerId'))
      );

      allow delete: if isAuth() && isAdmin();
    }

    // =========================================================
    // ====================== EMPLOYEES ========================
    // =========================================================
    match /apps/horarios/employees/{empleadoId} {
      allow read: if true;

      allow create: if isAuth()
        && request.resource.data.userId == uid();

      allow update: if isAuth()
        && canActFor(resource.data.userId)
        && protectUserId(resource.data.userId);

      allow delete: if isAuth()
        && (resource.data.userId == uid() || isAdmin());
    }

    // =========================================================
    // ======================= SHIFTS ==========================
    // =========================================================
    match /apps/horarios/shifts/{turnoId} {
      allow read: if true;

      allow create: if isAuth()
        && request.resource.data.userId == uid();

      allow update: if isAuth()
        && canActFor(resource.data.userId)
        && protectUserId(resource.data.userId);

      allow delete: if isAuth()
        && (resource.data.userId == uid() || isAdmin());
    }

    // =========================================================
    // ====================== SCHEDULES ========================
    // =========================================================
    match /apps/horarios/schedules/{horarioId} {
      allow read: if true;

      allow create: if isAuth()
        && request.resource.data.createdBy == uid();

      allow update: if isAuth()
        && (resource.data.createdBy == uid() || isAdmin())
        && protectCreatedBy();

      allow delete: if isAuth()
        && (resource.data.createdBy == uid() || isAdmin());
    }

    // =========================================================
    // ====================== HISTORIAL ========================
    // =========================================================
    match /apps/horarios/historial/{historialId} {
      allow read: if isAuth() && resource.data.createdBy == uid();
      allow create: if isAuth() && request.resource.data.createdBy == uid();
      allow update: if false;
      allow delete: if isAuth() && (resource.data.createdBy == uid() || isAdmin());
    }

    // =========================================================
    // ======================== CONFIG =========================
    // =========================================================
    match /apps/horarios/config/{configId} {
      allow read: if true;
      allow create, update: if isAuth() && configId == uid();
      allow delete: if false;
    }

    // =========================================================
    // ===================== INVITACIONES ======================
    // =========================================================
    match /apps/horarios/invitaciones/{invitacionId} {
      allow read: if true;

      allow create: if isAuth()
        && request.resource.data.ownerId == uid();

      allow update, delete: if isAuth()
        && (resource.data.ownerId == uid() || isAdmin());
    }

    // =========================================================
    // ======================= PEDIDOS =========================
    // =========================================================
    match /apps/horarios/pedidos/{pedidoId} {
      allow read: if true;

      allow create: if isAuth()
        && request.resource.data.userId == uid()
        && !isInvited();

      allow update: if isAuth()
        && canActFor(resource.data.userId)
        && protectUserId(resource.data.userId);

      allow delete: if isAuth()
        && (resource.data.userId == uid() || isAdmin());
    }

    // =========================================================
    // ======================= PRODUCTS ========================
    // =========================================================
    match /apps/horarios/products/{productoId} {
      allow read: if true;

      allow create: if isAuth()
        && (request.resource.data.userId == uid()
            || invitedActingFor(request.resource.data.userId));

      allow update: if isAuth()
        && canActFor(resource.data.userId)
        && protectUserId(resource.data.userId);

      allow delete: if isAuth()
        && (resource.data.userId == uid() || isAdmin());
    }

    // =========================================================
    // =================== STOCK MOVIMIENTOS ===================
    // =========================================================
    match /apps/horarios/stock_movimientos/{movimientoId} {
      allow read: if isAuth() && canActFor(resource.data.userId);

      allow create: if isAuth()
        && (request.resource.data.userId == uid()
            || invitedActingFor(request.resource.data.userId));

      allow update: if false;

      allow delete: if isAuth()
        && (resource.data.userId == uid() || isAdmin());
    }

    // =========================================================
    // ====================== STOCK ACTUAL =====================
    // =========================================================
    match /apps/horarios/stock_actual/{stockId} {
      allow read: if isAuth() && canActFor(resource.data.userId);

      allow create: if isAuth()
        && (request.resource.data.userId == uid()
            || invitedActingFor(request.resource.data.userId));

      allow update: if isAuth()
        && canActFor(resource.data.userId)
        && protectUserId(resource.data.userId);

      allow delete: if isAuth()
        && (resource.data.userId == uid() || isAdmin());
    }

    // =========================================================
    // ======================== REMITOS ========================
    // =========================================================
    match /apps/horarios/remitos/{remitoId} {
      allow read: if isAuth()
        && (canActFor(resource.data.userId) || isFactory());

      allow create: if isAuth()
        && (request.resource.data.userId == uid()
            || invitedActingFor(request.resource.data.userId)
            || isFactory()
            || isAdmin());

      allow update: if isAuth()
        && (canActFor(resource.data.userId) || isFactory())
        && protectUserId(resource.data.userId);

      allow delete: if isAuth()
        && (resource.data.userId == uid() || isAdmin() || isFactory());
    }

    // =========================================================
    // ======================= RECEPCIONES =====================
    // =========================================================
    match /apps/horarios/recepciones/{recepcionId} {
      allow read: if isAuth() && canActFor(resource.data.userId);

      allow create: if isAuth()
        && request.resource.data.userId == uid();

      allow update: if isAuth()
        && canActFor(resource.data.userId)
        && protectUserId(resource.data.userId);

      allow delete: if isAuth()
        && (resource.data.userId == uid() || isAdmin());
    }

    // =========================================================
    // ==================== ENLACES PUBLICOS ===================
    // =========================================================
    match /apps/horarios/enlaces_publicos/{enlaceId} {
      allow read: if true;

      allow create: if isAuth()
        && (request.resource.data.userId == uid()
            || invitedActingFor(request.resource.data.userId)
            || isAdmin());

      allow update: if isAuth()
        && (canActFor(resource.data.userId) || isFactory())
        && protectUserId(resource.data.userId);

      allow delete: if isAuth()
        && (resource.data.userId == uid() || isAdmin());
    }

    // =========================================================
    // ===================== CONVERSACIONES ====================
    // =========================================================
    match /apps/horarios/conversaciones/{conversacionId} {
      function canAccessConversation() {
        return resource.data != null
          && ('participantes' in resource.data)
          && isParticipantArray(resource.data.participantes);
      }

      allow read: if isAuth() && canAccessConversation();

      allow create: if isAuth()
        && ('participantes' in request.resource.data)
        && isParticipantArray(request.resource.data.participantes);

      allow update, delete: if isAuth() && canAccessConversation();
    }

    // =========================================================
    // ======================== MENSAJES =======================
    // =========================================================
    match /apps/horarios/mensajes/{mensajeId} {
      function canAccessConvId(convId) {
        return exists(/databases/$(database)/documents/apps/horarios/conversaciones/$(convId))
          && ('participantes' in get(/databases/$(database)/documents/apps/horarios/conversaciones/$(convId)).data)
          && isParticipantArray(
               get(/databases/$(database)/documents/apps/horarios/conversaciones/$(convId)).data.participantes
             );
      }

      allow read: if isAuth()
        && canAccessConvId(resource.data.conversacionId);

      allow create: if isAuth()
        && request.resource.data.remitenteId == uid()
        && canAccessConvId(request.resource.data.conversacionId);

      allow update: if isAuth()
        && canAccessConvId(resource.data.conversacionId)
        && protectFieldUnchanged('remitenteId')
        && protectFieldUnchanged('contenido')
        && protectFieldUnchanged('conversacionId');

      allow delete: if isAuth()
        && (resource.data.remitenteId == uid() || isAdmin());
    }
// =========================================================
// ============ EMPLOYEE FIXED RULES (HORARIOS FIJOS) ======
// =========================================================
match /apps/horarios/employee_fixed_rules/{ruleId} {

  // Lectura:
  // - cualquiera autenticado que pueda actuar para el owner
  allow read: if isAuth()
    && canActFor(resource.data.ownerId);

  // Creación:
  allow create: if isAuth()
    // owner correcto
    && request.resource.data.ownerId == myOwnerId()
    // usuario creador correcto
    && request.resource.data.createdBy == uid()
    // employeeId obligatorio
    && ('employeeId' in request.resource.data)
    // día válido
    && request.resource.data.dayOfWeek >= 0
    && request.resource.data.dayOfWeek <= 6;

  // Actualización:
  allow update: if isAuth()
    && canActFor(resource.data.ownerId)
    // no permitir cambiar owner
    && protectFieldUnchanged('ownerId')
    // no permitir cambiar empleado
    && protectFieldUnchanged('employeeId')
    // no permitir cambiar creador
    && protectCreatedBy();

  // Eliminación:
  allow delete: if isAuth()
    && canActFor(resource.data.ownerId);
}
// =========================================================
// ================= EMPLOYEE REQUESTS =====================
// =========================================================
match /apps/horarios/employee_requests/{requestId} {

  // Lectura:
  // - empleado autenticado
  // - roles con acceso (admin / manager / factory / invitado)
  // IMPORTANTE: NO usar resource.data en read (queries)
  allow read: if isAuth();

  // Creación:
  // - solo el empleado autenticado
  allow create: if isAuth()
    && request.resource.data.userId == uid()
    && request.resource.data.ownerId == myOwnerId();

  // Update:
  // - owner / admin / manager
  // - el empleado NO puede editar una vez creada
  allow update: if isAuth()
    && canActFor(resource.data.ownerId)
    && protectFieldUnchanged('userId')
    && protectFieldUnchanged('employeeId')
    && protectFieldUnchanged('ownerId');

  // Delete:
  // - owner o admin
  allow delete: if isAuth()
    && canActFor(resource.data.ownerId);
}

    // =========================================================
    // ===================== DEFAULT DENY ======================
    // =========================================================
    match /{document=**} {
      allow read, write: if false;
    }
 