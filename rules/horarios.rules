/* ===============================
   HORARIOS – LECTURA PÚBLICA
   =============================== */

/* ========= HELPERS ========= */

function horariosUserOwnerId() {
  return isAuth()
    && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
    ? get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId
    : null;
}

function horariosCanActFor(ownerId) {
  return isAuth()
    && ownerId != null
    && (
      uid() == ownerId
      || (
        exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
        &&
        get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId == ownerId
      )
      || (
        exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
        &&
        get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role
          in ['admin','manager','factory','maxdev']
      )
    );
}



/* ===============================
   PUBLIC COMPANIES
   =============================== */

match /apps/horarios/publicCompanies/{slug} {
  allow read: if true;

  allow create: if isAuth()
    && request.resource.data.ownerId == uid();

  allow update, delete: if false;
}

/* ===============================
   PUBLIC SCHEDULES
   =============================== */

match /apps/horarios/publicSchedules/{companySlug}/weeks/{weekId} {
  allow read: if true;

  allow create, update: if isAuth()
    && request.resource.data.ownerId == uid();

  allow delete: if false;
}

/* ===============================
   PUBLIC OWNERS
   =============================== */

match /apps/horarios/publicOwners/{ownerId} {
  allow read: if true;
  allow write: if horariosCanActFor(ownerId);
}

/* ===============================
   PRODUCTS
   =============================== */

match /apps/horarios/products/{docId} {
  allow read: if true;

  allow create: if horariosCanActFor(request.resource.data.ownerId);
  allow update, delete: if horariosCanActFor(
    resource.data.ownerId != null
      ? resource.data.ownerId
      : request.resource.data.ownerId
  );
}

/* ===============================
   PEDIDOS
   =============================== */

match /apps/horarios/pedidos/{docId} {
  allow read: if true;

  allow create: if horariosCanActFor(request.resource.data.ownerId);
  allow update, delete: if horariosCanActFor(
    resource.data.ownerId != null
      ? resource.data.ownerId
      : request.resource.data.ownerId
  );
}

match /apps/horarios/pedidos/{docId}/{sub=**} {
  allow read: if true;

  allow create: if horariosCanActFor(request.resource.data.ownerId);
  allow update, delete: if horariosCanActFor(
    resource.data.ownerId != null
      ? resource.data.ownerId
      : request.resource.data.ownerId
  );
}

/* ===============================
   STOCK ACTUAL
   =============================== */

match /apps/horarios/stock_actual/{docId} {
  allow read: if true;

  allow create: if horariosCanActFor(request.resource.data.ownerId);
  allow update, delete: if horariosCanActFor(
    resource.data.ownerId != null
      ? resource.data.ownerId
      : request.resource.data.ownerId
  );
}

/* ===============================
   STOCK MOVIMIENTOS
   =============================== */

match /apps/horarios/stock_movimientos/{docId} {
  allow read: if true;

  allow create: if horariosCanActFor(request.resource.data.ownerId);
  allow update, delete: if horariosCanActFor(
    resource.data.ownerId != null
      ? resource.data.ownerId
      : request.resource.data.ownerId
  );
}

/* ===============================
   USERS
   =============================== */

match /apps/horarios/users/{userId} {
  allow read: if isAuth()
    && (
      userId == uid()
      || (
        exists(/databases/$(db)/documents/apps/horarios/users/$(userId))
        && horariosCanActFor(
          get(/databases/$(db)/documents/apps/horarios/users/$(userId)).data.ownerId
        )
      )
    );

  allow create: if isAuth() && userId == uid();

  allow update: if isAuth()
    && (
      userId == uid()
      || (
        resource.data.ownerId != null
        && horariosCanActFor(resource.data.ownerId)
      )
    );

  allow delete: if isAuth()
    && (
      userId == uid()
      || resource.data.ownerId == uid()
      || (
        resource.data.ownerId != null
        && horariosCanActFor(resource.data.ownerId)
      )
    );
}

/* ===============================
   INVITACIONES
   =============================== */

match /apps/horarios/invitaciones/{docId} {
  allow read: if true;

  allow create: if isAuth();

  allow update: if isAuth()
    && (
      resource.data.ownerId == uid()
      ||
      (
        request.resource.data.usado == true
        && request.resource.data.usadoPor == uid()
        && request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(["usado", "usadoPor", "usadoEn"])
      )
    );

  allow delete: if isAuth()
    && resource.data.ownerId != null
    && horariosCanActFor(resource.data.ownerId);
}

/* ===============================
   EMPLOYEES
   =============================== */

match /apps/horarios/employees/{docId} {
  allow read: if true;

  allow create: if horariosCanActFor(request.resource.data.ownerId);

  allow update, delete: if horariosCanActFor(
    resource.data.ownerId != null
      ? resource.data.ownerId
      : request.resource.data.ownerId
  );
}


/* ===============================
   SHIFTS
   =============================== */

match /apps/horarios/shifts/{docId} {
  allow read: if true;

  allow create: if horariosCanActFor(request.resource.data.ownerId);
  allow update, delete: if horariosCanActFor(
    resource.data.ownerId != null
      ? resource.data.ownerId
      : request.resource.data.ownerId
  );
}

/* ===============================
   SCHEDULES
   =============================== */

match /apps/horarios/schedules/{docId} {

  allow read: if true;

  allow create: if horariosCanActFor(request.resource.data.ownerId);

  allow update, delete: if isAuth();
}

/* ===============================
   HISTORIAL (cambios de horarios)
   =============================== */

match /apps/horarios/historial/{historialId} {
  allow read: if isAuth() && resource.data.createdBy == uid();

  allow create: if isAuth() && request.resource.data.createdBy == uid();

  allow update: if false;

  allow delete: if isAuth() && resource.data.createdBy == uid();
}

/* ===============================
   EMPLOYEE FIXED RULES
   =============================== */

match /apps/horarios/employee_fixed_rules/{ruleId} {

  allow read: if isAuth() && (
    resource.data.ownerId == uid()
    ||
    (
      exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
      &&
      get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId
        == resource.data.ownerId
    )
    ||
    (
      exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
      &&
      get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role
        in ['admin', 'manager', 'factory', 'maxdev']
    )
  );

  allow create: if horariosCanActFor(request.resource.data.ownerId);

  allow update, delete: if horariosCanActFor(
    resource.data.ownerId != null
      ? resource.data.ownerId
      : request.resource.data.ownerId
  );
}


/* ===============================
   ENLACES PUBLICOS
   =============================== */

match /apps/horarios/enlaces_publicos/{ownerId} {
  allow read: if true;

  allow create, update: if isAuth() && horariosCanActFor(ownerId);

  allow delete: if isAuth() && horariosCanActFor(ownerId);
}

/* ===============================
   CONFIG
   =============================== */

match /apps/horarios/config/{docId} {
  allow read: if true;

  allow create: if horariosCanActFor(request.resource.data.ownerId);

  allow update, delete: if horariosCanActFor(
    resource.data.ownerId != null
      ? resource.data.ownerId
      : request.resource.data.ownerId
  );
}
