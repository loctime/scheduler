/* ===============================
   HORARIOS – VERSION LIMPIA
   =============================== */

/* ========= HELPERS ========= */

function canActFor(ownerId) {
  return isAuth() && (
    request.auth.uid == ownerId ||
    (
      exists(/databases/$(db)/documents/apps/horarios/users/$(request.auth.uid))
      &&
      get(/databases/$(db)/documents/apps/horarios/users/$(request.auth.uid)).data.ownerId == ownerId
    )
  );
}

// Verifica si el owner tiene slug público activo
function ownerHasActivePublicSlug(ownerId) {
  return ownerId != null
    &&
    exists(
      /databases/$(db)/documents/apps/horarios/publicCompanies/$(ownerId)
    )
    &&
    get(
      /databases/$(db)/documents/apps/horarios/publicCompanies/$(ownerId)
    ).data.active == true;
}

/* ========= PUBLIC COMPANIES ========= */

match /apps/horarios/publicCompanies/{slug} {
  allow read: if resource.data.active == true;

  allow create: if isAuth()
    && request.resource.data.ownerId == request.auth.uid;

  allow update, delete: if false;
}

/* ========= PUBLIC SCHEDULES ========= */

match /apps/horarios/publicSchedules/{companySlug}/weeks/{weekId} {
  allow read: if true;

  allow create, update: if isAuth()
    && request.resource.data.ownerId == request.auth.uid;

  allow delete: if false;
}

/* ========= PRODUCTS ========= */

match /apps/horarios/products/{productId} {
  allow read: if isAuth();

  allow update: if isAuth()
    && request.resource.data.ownerId == resource.data.ownerId;

  allow create, delete: if false;
}

/* ========= STOCK MOVIMIENTOS ========= */

match /apps/horarios/stock_movimientos/{movId} {
  allow read: if isAuth();

  allow create: if isAuth()
    && request.resource.data.userId == uid()
    && request.resource.data.ownerId is string;

  allow update, delete: if false;
}

/* ========= USERS ========= */

match /apps/horarios/users/{userId} {
  allow create: if isAuth() && userId == request.auth.uid;
  allow read, update: if isAuth() && userId == request.auth.uid;
  allow delete: if false;
}

/* ========= INVITACIONES ========= */

match /apps/horarios/invitaciones/{invitacionId} {
  allow read: if isAuth();

  allow update: if isAuth()
    && (
      resource.data.ownerId == uid()
      ||
      (
        request.resource.data.usado == true
        && request.resource.data.usadoPor == uid()
        && request.resource.data.diff(resource.data).affectedKeys()
           .hasOnly(["usado", "usadoPor", "usadoEn"])
      )
    );

  allow create: if isAuth();
  allow delete: if false;
}

/* ========= EMPLOYEES ========= */

match /apps/horarios/employees/{docId} {

  allow read: if
    canActFor(resource.data.ownerId)
    ||
    ownerHasActivePublicSlug(resource.data.ownerId);

  allow write: if canActFor(request.resource.data.ownerId);
}

/* ========= SHIFTS ========= */

match /apps/horarios/shifts/{docId} {

  allow read: if
    canActFor(resource.data.ownerId)
    ||
    ownerHasActivePublicSlug(resource.data.ownerId);

  allow write: if canActFor(request.resource.data.ownerId);
}

/* ========= SCHEDULES ========= */

match /apps/horarios/schedules/{docId} {

  allow read: if
    canActFor(resource.data.ownerId)
    ||
    ownerHasActivePublicSlug(resource.data.ownerId);

  allow write: if canActFor(request.resource.data.ownerId);
}

/* ========= CONFIG ========= */

match /apps/horarios/config/{ownerId} {

  allow read: if
    canActFor(ownerId)
    ||
    ownerHasActivePublicSlug(ownerId);

  allow write: if canActFor(ownerId);
}

/* ========= FALLBACK ========= */

match /apps/horarios/{document=**} {
  allow read: if false;
  allow write: if false;
}
