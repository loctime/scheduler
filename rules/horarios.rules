// ========= HORARIOS SCHEDULER =========

// Helper para verificar si el usuario es factory
function isFactory() {
  return isAuth() 
    && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
    && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role == 'factory';
}

// Helper para verificar si el usuario es admin
function isAdmin() {
  return isAuth() 
    && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
    && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role == 'admin';
}

// Helper para verificar si el usuario es manager
function isManager() {
  return isAuth() 
    && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
    && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role == 'manager';
}

// Helper para verificar si un usuario pertenece a un grupo donde el usuario actual es manager
function usuarioPerteneceAGrupoDelManager(userId: string) {
  if (!isManager()) return false;
  // Buscar grupos donde el usuario actual es manager
  // Nota: Firestore rules no permite queries complejas, así que verificamos si el usuario tiene grupoIds
  // y si alguno de esos grupos tiene al manager actual
  let userGrupoIds = [];
  if (exists(/databases/$(db)/documents/apps/horarios/users/$(userId))) {
    let userData = get(/databases/$(db)/documents/apps/horarios/users/$(userId)).data;
    userGrupoIds = userData.grupoIds != null ? userData.grupoIds : [];
  }
  // Verificar si alguno de los grupos del usuario tiene al manager actual
  // Como no podemos hacer queries, verificamos si el manager tiene grupos asignados
  let managerGrupoIds = [];
  if (exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))) {
    let managerData = get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data;
    managerGrupoIds = managerData.grupoIds != null ? managerData.grupoIds : [];
  }
  // Verificar intersección (si hay grupos en común)
  // Como las reglas son limitadas, usamos una aproximación: verificamos si el manager es manager de algún grupo
  // que contenga al usuario. Para esto, necesitamos verificar en la colección groups
  // Pero las reglas no permiten queries eficientes, así que usamos una verificación más simple:
  // Si el usuario tiene grupoIds y el manager tiene grupoIds, y hay intersección, permitir
  // Por ahora, verificamos si el manager es manager de algún grupo que contenga al userId
  // Esto requiere verificar en groups, pero como no podemos hacer queries eficientes en reglas,
  // usamos una verificación más permisiva: si el manager tiene grupoIds, permitir acceso a usuarios
  // que también tengan grupoIds (esto se refinará en la aplicación)
  return userGrupoIds.size() > 0 && managerGrupoIds.size() > 0;
}

// Helper mejorado: verificar si el manager es manager de un grupo que contiene al usuario
// Nota: Las reglas de Firestore tienen limitaciones para verificar intersecciones de arrays
// Por lo tanto, permitimos que el manager acceda a usuarios que tengan grupoIds
// La aplicación se encargará de filtrar correctamente según los grupos del manager
function esManagerDelGrupoDelUsuario(userId: string) {
  if (!isManager()) return false;
  // Verificar que el usuario tenga grupoIds (pertenece a algún grupo)
  // La aplicación verificará que el manager sea manager de esos grupos
  return exists(/databases/$(db)/documents/apps/horarios/users/$(userId))
    && get(/databases/$(db)/documents/apps/horarios/users/$(userId)).data.grupoIds != null
    && get(/databases/$(db)/documents/apps/horarios/users/$(userId)).data.grupoIds.size() > 0;
}

// Helper para verificar si un pedido puede ser actualizado sin autenticación
function pedidoPuedeActualizarseSinAuth() {
  return !('estado' in resource.data) 
    || resource.data.estado == null
    || (resource.data.estado != "enviado" 
        && resource.data.estado != "recibido" 
        && resource.data.estado != "completado");
}

// Helper para verificar si se puede actualizar el estado del pedido desde "enviado" a "recibido" o "completado"
function puedeActualizarEstadoRecepcion() {
  return resource.data.estado == "enviado" 
    && request.resource.data.estado != null
    && (request.resource.data.estado == "recibido" || request.resource.data.estado == "completado");
}

// Colección: apps/horarios/users
match /apps/horarios/users/{userId} {
  // Permitir lectura:
  // - El usuario puede leer su propio documento
  // - El dueño puede leer documentos de usuarios invitados vinculados a sus invitaciones
  // - Admin puede leer todos los usuarios
  // - Manager puede leer usuarios de sus grupos
  allow read: if isAuth() && (
    userId == uid()
    || (exists(/databases/$(db)/documents/apps/horarios/users/$(userId))
      && get(/databases/$(db)/documents/apps/horarios/users/$(userId)).data.role == 'invited'
      && get(/databases/$(db)/documents/apps/horarios/users/$(userId)).data.ownerId == uid())
    || isAdmin()
    || (isManager() && esManagerDelGrupoDelUsuario(userId))
  );
  // Crear: el usuario puede crear su propio documento
  allow create: if isAuth() && userId == uid();
  // Actualizar: 
  // - El usuario puede actualizar su propio documento (pero no puede cambiar su rol)
  // - Admin puede actualizar cualquier usuario, incluyendo roles
  // - Manager puede actualizar usuarios de sus grupos (puede cambiar roles dentro de su grupo: branch/factory)
  allow update: if isAuth() && (
    (userId == uid() && (
      // Usuario actualizando su propio documento: no puede cambiar rol ni uid
      (!('role' in request.resource.data) || request.resource.data.role == resource.data.role)
      && (!('uid' in resource.data) || 
        !('uid' in request.resource.data) || 
        request.resource.data.uid == resource.data.uid)
    ))
    || (isAdmin() && (
      // Admin puede cambiar cualquier campo excepto uid (proteger uid)
      (!('uid' in resource.data) || 
        !('uid' in request.resource.data) || 
        request.resource.data.uid == resource.data.uid)
    ))
    || (isManager() && esManagerDelGrupoDelUsuario(userId) && (
      // Manager puede cambiar roles dentro de su grupo (solo branch y factory)
      // No puede cambiar a admin, manager, o invited
      (!('role' in request.resource.data) 
        || request.resource.data.role == 'branch' 
        || request.resource.data.role == 'factory'
        || request.resource.data.role == resource.data.role)
      && (!('uid' in resource.data) || 
        !('uid' in request.resource.data) || 
        request.resource.data.uid == resource.data.uid)
    ))
  );
  // Eliminar: 
  // - El usuario puede eliminar su propio documento
  // - El dueño puede eliminar usuarios invitados vinculados a sus invitaciones
  // - Admin puede eliminar cualquier usuario
  // - Manager puede eliminar usuarios de sus grupos
  allow delete: if isAuth() && (
    userId == uid()
    || (exists(/databases/$(db)/documents/apps/horarios/users/$(userId))
      && get(/databases/$(db)/documents/apps/horarios/users/$(userId)).data.role == 'invited'
      && get(/databases/$(db)/documents/apps/horarios/users/$(userId)).data.ownerId == uid())
    || isAdmin()
    || (isManager() && esManagerDelGrupoDelUsuario(userId))
  );
}

// Colección: apps/horarios/groups
match /apps/horarios/groups/{groupId} {
  // Permitir lectura:
  // - Admin puede leer todos los grupos
  // - Manager puede leer grupos donde es manager
  // - Usuarios pueden leer grupos a los que pertenecen
  allow read: if isAuth() && (
    isAdmin()
    || (isManager() && exists(/databases/$(db)/documents/apps/horarios/groups/$(groupId))
      && get(/databases/$(db)/documents/apps/horarios/groups/$(groupId)).data.managerId == uid())
    || (exists(/databases/$(db)/documents/apps/horarios/groups/$(groupId))
      && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.grupoIds != null
      && uid() in get(/databases/$(db)/documents/apps/horarios/groups/$(groupId)).data.userIds)
  );
  // Crear: solo admin puede crear grupos
  allow create: if isAuth() && isAdmin();
  // Actualizar: 
  // - Admin puede actualizar cualquier grupo
  // - Manager puede actualizar grupos donde es manager (pero no puede cambiar managerId)
  allow update: if isAuth() && (
    isAdmin()
    || (isManager() 
      && exists(/databases/$(db)/documents/apps/horarios/groups/$(groupId))
      && get(/databases/$(db)/documents/apps/horarios/groups/$(groupId)).data.managerId == uid()
      && (!('managerId' in request.resource.data) || request.resource.data.managerId == resource.data.managerId))
  );
  // Eliminar: solo admin puede eliminar grupos
  allow delete: if isAuth() && isAdmin();
}

// Colección: apps/horarios/employees
match /apps/horarios/employees/{empleadoId} {
  // Permitir lectura pública (para página compartible)
  allow read: if true;
  // Crear: verificar que userId sea correcto
  allow create: if isAuth() && request.resource.data.userId == uid();
  // Actualizar: verificar propiedad y proteger userId
  allow update: if isAuth() && resource.data.userId == uid()
    && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId);
  // Eliminar: solo el dueño
  allow delete: if isAuth() && resource.data.userId == uid();
}

// Colección: apps/horarios/shifts
match /apps/horarios/shifts/{turnoId} {
  // Permitir lectura pública (para página compartible)
  allow read: if true;
  // Crear: verificar que userId sea correcto
  allow create: if isAuth() && request.resource.data.userId == uid();
  // Actualizar: verificar propiedad y proteger userId
  allow update: if isAuth() && resource.data.userId == uid()
    && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId);
  // Eliminar: solo el dueño
  allow delete: if isAuth() && resource.data.userId == uid();
}

// Colección: apps/horarios/schedules
match /apps/horarios/schedules/{horarioId} {
  // Permitir lectura pública (para página compartible)
  allow read: if true;
  // Crear: verificar que createdBy sea correcto
  allow create: if isAuth() && request.resource.data.createdBy == uid();
  // Actualizar: verificar propiedad y proteger createdBy
  allow update: if isAuth() && resource.data.createdBy == uid()
    && (!('createdBy' in request.resource.data) || request.resource.data.createdBy == resource.data.createdBy);
  // Eliminar: solo el dueño
  allow delete: if isAuth() && resource.data.createdBy == uid();
}

// Colección: apps/horarios/historial
match /apps/horarios/historial/{historialId} {
  // Solo el dueño puede leer
  allow read: if isAuth() && resource.data.createdBy == uid();
  // Crear: verificar que createdBy sea correcto
  allow create: if isAuth() && request.resource.data.createdBy == uid();
  // Historial es inmutable
  allow update: if false;
  // Eliminar: solo el dueño
  allow delete: if isAuth() && resource.data.createdBy == uid();
}

// Colección: apps/horarios/config
match /apps/horarios/config/{configId} {
  // Permitir lectura pública (para página compartible)
  allow read: if true;
  // Solo el usuario puede editar su propia configuración (configId debe ser su uid)
  allow write: if isAuth() && configId == uid();
  // No permitir eliminar configuración
  allow delete: if false;
}

// Colección: apps/horarios/invitaciones
match /apps/horarios/invitaciones/{invitacionId} {
  // Permitir lectura sin autenticación para validar tokens en registro
  // Esto es necesario porque el registro se hace sin autenticación
  allow read: if true;
  // El dueño puede crear invitaciones
  allow create: if isAuth() && request.resource.data.ownerId == uid();
  // Actualizar:
  // - El dueño puede actualizar cualquier cosa
  // - Cualquier usuario autenticado puede marcar como usada (protegiendo campos sensibles)
  allow update: if isAuth() && (
    // El ownerId puede hacer cualquier actualización
    resource.data.ownerId == uid()
    // O cualquier usuario autenticado puede marcar como usada
    || (
      // Solo si la invitación no está ya usada
      (resource.data.usado == null || resource.data.usado == false || !('usado' in resource.data))
      // Proteger campos sensibles (no se pueden cambiar)
      && (!('ownerId' in request.resource.data) || request.resource.data.ownerId == resource.data.ownerId)
      && (!('token' in request.resource.data) || request.resource.data.token == resource.data.token)
      && (!('activo' in request.resource.data) || request.resource.data.activo == resource.data.activo)
    )
  );
  // Eliminar: solo el dueño puede eliminar sus invitaciones
  allow delete: if isAuth() && resource.data.ownerId == uid();
}

// Colección: apps/horarios/pedidos
match /apps/horarios/pedidos/{pedidoId} {
  // Permitir lectura si es el dueño O si es un usuario invitado del dueño O si es factory O si no hay autenticación
  allow read: if (isAuth() && resource.data.userId == uid()) 
    || (isAuth() && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role == 'invited'
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId == resource.data.userId)
    || isFactory()
    || !isAuth();
  // Crear: verificar que userId sea correcto (solo dueños pueden crear)
  allow create: if isAuth() && request.resource.data.userId == uid()
    && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
    && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role != 'invited';
  // Actualizar: 
  // - Si está autenticado como dueño: verificar propiedad y proteger userId
  // - Si está autenticado como invitado: permitir actualizar si el pedido pertenece a su ownerId
  // - Si es factory: permitir actualizar estado a "processing" o "enviado" y asignar assignedTo
  // - Si NO está autenticado: 
  //   a) Permitir si el pedido NO está en estado "enviado", "recibido" o "completado" (pedidoPuedeActualizarseSinAuth)
  //   b) O permitir actualizar desde "enviado" a "recibido" o "completado" (puedeActualizarEstadoRecepcion)
  allow update: if (isAuth() && resource.data.userId == uid()
    && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId))
    || (isAuth() 
      && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role == 'invited'
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId == resource.data.userId
      && (
        // Permitir si el estado actual es "creado", "completado", null o undefined
        // (NO permitir si ya está "enviado" o "recibido")
        (!('estado' in resource.data)
        || resource.data.estado == null
        || resource.data.estado == "creado"
        || resource.data.estado == "completado")
      )
      && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId))
    || (isFactory()
      && (
        // Factory puede cambiar estado a "processing" o "enviado"
        (request.resource.data.estado == "processing" || request.resource.data.estado == "enviado")
        // Y puede asignar assignedTo
        || ('assignedTo' in request.resource.data)
        || ('assignedToNombre' in request.resource.data)
      )
      // Proteger userId del pedido
      && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId)
      // Permitir actualizar campos relacionados con el flujo de fábrica
      && (!('remitoEnvioId' in request.resource.data) || request.resource.data.remitoEnvioId != null)
      && (!('fechaEnvio' in request.resource.data) || request.resource.data.fechaEnvio != null))
    || (!isAuth() 
      && (pedidoPuedeActualizarseSinAuth() || puedeActualizarEstadoRecepcion())
      && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId)
      // Solo permitir actualizar campos específicos: estado, remitoEnvioId, fechaEnvio, fechaRecepcion, updatedAt
      && (!('nombre' in request.resource.data) || request.resource.data.nombre == resource.data.nombre)
      && (!('stockMinimoDefault' in request.resource.data) || request.resource.data.stockMinimoDefault == resource.data.stockMinimoDefault)
      && (!('formatoSalida' in request.resource.data) || request.resource.data.formatoSalida == resource.data.formatoSalida)
      && (!('mensajePrevio' in request.resource.data) || request.resource.data.mensajePrevio == resource.data.mensajePrevio)
      && (!('origenDefault' in request.resource.data) || request.resource.data.origenDefault == resource.data.origenDefault)
      && (!('destinoDefault' in request.resource.data) || request.resource.data.destinoDefault == resource.data.destinoDefault)
      && (!('createdAt' in request.resource.data) || request.resource.data.createdAt == resource.data.createdAt));
  // Eliminar: solo el dueño (no invitados)
  allow delete: if isAuth() && resource.data.userId == uid()
    && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
    && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role != 'invited';
}

// Colección: apps/horarios/products
match /apps/horarios/products/{productoId} {
  // Permitir lectura si es el dueño O si es un usuario invitado del dueño O si no hay autenticación
  allow read: if (isAuth() && resource.data.userId == uid()) 
    || (isAuth() && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role == 'invited'
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId == resource.data.userId)
    || !isAuth();
  // Crear: verificar que userId sea correcto (invitados pueden crear productos con ownerId)
  allow create: if isAuth() && (
    (request.resource.data.userId == uid() && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role != 'invited')
    || (exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role == 'invited'
      && request.resource.data.userId == get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId)
  );
  // Actualizar: verificar propiedad y proteger userId (invitados pueden actualizar productos del ownerId)
  allow update: if (isAuth() && resource.data.userId == uid()
    && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId))
    || (isAuth() 
      && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role == 'invited'
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId == resource.data.userId
      && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId));
  // Eliminar: solo el dueño (no invitados)
  allow delete: if isAuth() && resource.data.userId == uid()
    && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
    && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role != 'invited';
}

// Colección: apps/horarios/stock_movimientos
match /apps/horarios/stock_movimientos/{movimientoId} {
  // Permitir lectura si es el dueño O si es un usuario invitado del dueño
  allow read: if isAuth() && (
    resource.data.userId == uid()
    || (exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role == 'invited'
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId == resource.data.userId)
  );
  // Crear: verificar que userId sea correcto (permite usuarios invitados crear con ownerId)
  allow create: if isAuth() && (
    request.resource.data.userId == uid()
    || (exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role == 'invited'
      && request.resource.data.userId == get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId)
  );
  // Actualizar: verificar propiedad y proteger userId (los movimientos generalmente son inmutables)
  allow update: if isAuth() && resource.data.userId == uid()
    && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId);
  // Eliminar: solo el dueño
  allow delete: if isAuth() && resource.data.userId == uid();
}

// Colección: apps/horarios/stock_actual
match /apps/horarios/stock_actual/{stockId} {
  // Helper para verificar si el usuario es invitado
  function isInvitedUser() {
    return isAuth() 
      && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role == 'invited';
  }
  // Helper para obtener el ownerId del usuario invitado
  function getOwnerId() {
    return isInvitedUser() 
      ? get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId
      : null;
  }
  
  // Permitir lectura si es el dueño O si es un usuario invitado del dueño
  allow read: if isAuth() && (
    (resource.data != null && resource.data.userId == uid())
    || stockId.matches(uid() + '_.*')
    || (resource.data != null && isInvitedUser() && getOwnerId() != null && resource.data.userId == getOwnerId())
    || (isInvitedUser() && getOwnerId() != null && stockId.matches(getOwnerId() + '_.*'))
  );
  
  // Crear: verificar que userId sea correcto (permite usuarios invitados crear con ownerId)
  // Simplificado para permitir creación si el userId en el documento coincide con uid o ownerId
  allow create: if isAuth() && (
    // Usuario normal: userId debe coincidir con su uid
    (request.resource.data.userId == uid() || stockId.matches(uid() + '_.*'))
    // Usuario invitado: userId debe coincidir con su ownerId
    || (isInvitedUser() 
      && getOwnerId() != null 
      && (request.resource.data.userId == getOwnerId() || stockId.matches(getOwnerId() + '_.*')))
  );
  
  // Actualizar: verificar propiedad y proteger userId (permite usuarios invitados actualizar con ownerId)
  allow update: if isAuth() && (
    (resource.data != null && resource.data.userId == uid())
    || stockId.matches(uid() + '_.*')
    || (resource.data != null && isInvitedUser() && getOwnerId() != null && resource.data.userId == getOwnerId())
    || (isInvitedUser() && getOwnerId() != null && stockId.matches(getOwnerId() + '_.*'))
  ) && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId);
  
  // Eliminar: solo el dueño (permite usuarios invitados eliminar con ownerId)
  allow delete: if isAuth() && (
    (resource.data != null && resource.data.userId == uid())
    || stockId.matches(uid() + '_.*')
    || (resource.data != null && isInvitedUser() && getOwnerId() != null && resource.data.userId == getOwnerId())
    || (isInvitedUser() && getOwnerId() != null && stockId.matches(getOwnerId() + '_.*'))
  );
}

// Colección: apps/horarios/remitos
match /apps/horarios/remitos/{remitoId} {
  // Permitir lectura si es el dueño O si es un usuario invitado del dueño O si pertenece a un pedido del usuario O si es factory
  allow read: if isAuth() && (
    resource.data.userId == uid()
    || (exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role == 'invited'
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId == resource.data.userId)
    || (resource.data.pedidoId != null
      && exists(/databases/$(db)/documents/apps/horarios/pedidos/$(resource.data.pedidoId))
      && get(/databases/$(db)/documents/apps/horarios/pedidos/$(resource.data.pedidoId)).data.userId == uid())
    || isFactory()
  );
  // Crear: 
  // - Si está autenticado: verificar que userId sea correcto (permite usuarios invitados crear con ownerId)
  // - Si es factory: permitir crear remitos para pedidos que puede ver (el userId del remito debe ser el del pedido)
  // - Si NO está autenticado: permitir solo si el pedido existe y el userId coincide
  //   (la aplicación controla que el pedido esté en estado válido antes de crear el remito)
  allow create: if (isAuth() && (
    request.resource.data.userId == uid()
    || (exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role == 'invited'
      && request.resource.data.userId == get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId)
    || (isFactory()
      && request.resource.data.pedidoId != null
      && exists(/databases/$(db)/documents/apps/horarios/pedidos/$(request.resource.data.pedidoId))
      && request.resource.data.userId != null
      && request.resource.data.userId == get(/databases/$(db)/documents/apps/horarios/pedidos/$(request.resource.data.pedidoId)).data.userId)
  ))
    || (!isAuth() 
      && request.resource.data.pedidoId != null
      && exists(/databases/$(db)/documents/apps/horarios/pedidos/$(request.resource.data.pedidoId))
      && request.resource.data.userId != null
      && request.resource.data.userId == get(/databases/$(db)/documents/apps/horarios/pedidos/$(request.resource.data.pedidoId)).data.userId);
  // Actualizar: verificar propiedad y proteger userId
  allow update: if isAuth() && resource.data.userId == uid()
    && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId);
  // Eliminar: 
  // - Si está autenticado: solo el dueño (por userId o por pedido asociado)
  // - Si NO está autenticado: permitir eliminar remitos de tipo "pedido" o "envio" que pertenezcan a un pedido válido
  //   (esto permite limpiar remitos anteriores cuando se crea una recepción desde enlace público)
  allow delete: if isAuth() && (
    resource.data.userId == uid()
    || (resource.data.pedidoId != null
      && exists(/databases/$(db)/documents/apps/horarios/pedidos/$(resource.data.pedidoId))
      && get(/databases/$(db)/documents/apps/horarios/pedidos/$(resource.data.pedidoId)).data.userId == uid())
  )
    || (!isAuth() 
      && resource.data.pedidoId != null
      && exists(/databases/$(db)/documents/apps/horarios/pedidos/$(resource.data.pedidoId))
      && resource.data.userId != null
      && resource.data.userId == get(/databases/$(db)/documents/apps/horarios/pedidos/$(resource.data.pedidoId)).data.userId
      && (resource.data.tipo == "pedido" || resource.data.tipo == "envio")
      && !resource.data.final);
}

// Colección: apps/horarios/recepciones
match /apps/horarios/recepciones/{recepcionId} {
  // Solo el dueño puede leer sus recepciones
  allow read: if isAuth() && resource.data.userId == uid();
  // Crear: verificar que userId sea correcto
  allow create: if isAuth() && request.resource.data.userId == uid();
  // Actualizar: verificar propiedad y proteger userId
  allow update: if isAuth() && resource.data.userId == uid()
    && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId);
  // Eliminar: solo el dueño
  allow delete: if isAuth() && resource.data.userId == uid();
}

// Colección: apps/horarios/enlaces_publicos
match /apps/horarios/enlaces_publicos/{enlaceId} {
  // Helper para verificar si el usuario es invitado
  function isInvitedUser() {
    return isAuth() 
      && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role == 'invited';
  }
  // Helper para obtener el ownerId del usuario invitado
  function getOwnerId() {
    return isInvitedUser() 
      ? get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId
      : null;
  }
  
  // Permitir lectura pública (para que la fábrica pueda acceder sin login)
  allow read: if true;
  // Crear: verificar que userId sea correcto (permite usuarios invitados crear con ownerId)
  allow create: if isAuth() && (
    request.resource.data.userId == uid()
    || (isInvitedUser() && getOwnerId() != null && request.resource.data.userId == getOwnerId())
  );
  // Actualizar: 
  // - Si está autenticado: verificar propiedad y proteger userId (permite usuarios invitados actualizar con ownerId)
  // - Si NO está autenticado: permitir actualizar cuando está activo
  //   - Proteger campos sensibles (userId, pedidoId, createdAt)
  //   - Permitir actualizar productosDisponibles, fechaAcceso
  //   - Permitir desactivar solo si el pedido está enviado
  allow update: if (isAuth() && (
    resource.data.userId == uid()
    || (isInvitedUser() && getOwnerId() != null && resource.data.userId == getOwnerId())
  ) && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId))
    || (!isAuth() 
      && resource.data.activo == true
      // Proteger campos sensibles
      && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId)
      && (!('pedidoId' in request.resource.data) || request.resource.data.pedidoId == resource.data.pedidoId)
      && (!('createdAt' in request.resource.data) || request.resource.data.createdAt == resource.data.createdAt)
      && (
        // Caso 1: No se modifica activo o no está en request - permitir actualizar
        (!('activo' in request.resource.data) || request.resource.data.activo == true)
        // Caso 2: Se intenta desactivar - solo si el pedido está enviado
        || (request.resource.data.activo == false
          && exists(/databases/$(db)/documents/apps/horarios/pedidos/$(resource.data.pedidoId))
          && get(/databases/$(db)/documents/apps/horarios/pedidos/$(resource.data.pedidoId)).data.estado == "enviado")
      ));
  // Eliminar: solo el dueño (permite usuarios invitados eliminar con ownerId)
  allow delete: if isAuth() && (
    resource.data.userId == uid()
    || (isInvitedUser() && getOwnerId() != null && resource.data.userId == getOwnerId())
  );
}
