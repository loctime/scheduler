// ========= HORARIOS SCHEDULER =========

// Helper para verificar que el usuario tiene documento en apps/horarios/users
function horariosUserDocExists() {
  return isAuth() && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()));
}

// Colección: apps/horarios/users
match /apps/horarios/users/{userId} {
  allow read: if isAuth() && uid() == userId;
  allow create: if isAuth() && uid() == userId
    && nonEmptyString('uid')
    && request.resource.data.uid == uid()
    && isStringOrNull('email')
    && isStringOrNull('displayName')
    && isStringOrNull('photoURL')
    && isStringOrNull('role')
    && isTs('createdAt')
    && isTs('updatedAt');
  allow update: if isAuth() && uid() == userId
    && unchanged('uid')
    && isStringOrNull('email')
    && isStringOrNull('displayName')
    && isStringOrNull('photoURL')
    && isStringOrNull('role')
    && unchanged('createdAt');
  allow delete: if false; // No permitir eliminar usuarios
}

// Colección: apps/horarios/employees
match /apps/horarios/employees/{empleadoId} {
  allow read: if isAuth() && resource.data.userId == uid();
  allow create: if isAuth()
    && nonEmptyString('name')
    && nonEmptyString('userId')
    && request.resource.data.userId == uid()
        && isStringOrNull('email')
        && isStringOrNull('phone')
        && isTs('createdAt')
    && isTs('updatedAt');
  allow update: if isAuth()
    && resource.data.userId == uid()
    && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId)
    && (!('name' in request.resource.data) || (request.resource.data.name is string && request.resource.data.name.size() >= 1))
    && (!('email' in request.resource.data) || request.resource.data.email is string || request.resource.data.email == null)
    && (!('phone' in request.resource.data) || request.resource.data.phone is string || request.resource.data.phone == null)
    && unchanged('createdAt');
  allow delete: if isAuth() && resource.data.userId == uid();
}

// Colección: apps/horarios/shifts
match /apps/horarios/shifts/{turnoId} {
  allow read: if isAuth() && resource.data.userId == uid();
  allow create: if isAuth()
    && nonEmptyString('name')
    && nonEmptyString('userId')
    && request.resource.data.userId == uid()
    && isStringOrNull('startTime')
    && isStringOrNull('endTime')
    && isStringOrNull('startTime2')
    && isStringOrNull('endTime2')
    && nonEmptyString('color')
    && isTs('createdAt')
    && isTs('updatedAt');
  // Regla simplificada: solo verifica que el usuario es el dueño
  allow update: if isAuth() && resource.data.userId == uid();
  allow delete: if isAuth() && resource.data.userId == uid();
}

// Colección: apps/horarios/schedules
match /apps/horarios/schedules/{horarioId} {
  // Permitir lectura si el schedule tiene createdBy y coincide con el usuario, o si no tiene createdBy (schedules antiguos)
  allow read: if isAuth() && (
    (resource.data.createdBy != null && resource.data.createdBy == uid()) ||
    (!('createdBy' in resource.data))
  );
  allow create: if isAuth()
    && nonEmptyString('nombre')
    && nonEmptyString('weekStart')
    && nonEmptyString('semanaInicio')
    && nonEmptyString('semanaFin')
    && request.resource.data.assignments is map
    && isTs('createdAt')
    && isTs('updatedAt')
    && nonEmptyString('createdBy')
    && request.resource.data.createdBy == uid()
    && isStringOrNull('createdByName')
    && isStringOrNull('modifiedBy')
    && isStringOrNull('modifiedByName')
    && (request.resource.data.completada == null || request.resource.data.completada is bool)
    && (request.resource.data.completadaPor == null || request.resource.data.completadaPor is string)
    && (request.resource.data.completadaPorNombre == null || request.resource.data.completadaPorNombre is string)
    && (request.resource.data.completadaEn == null || request.resource.data.completadaEn is timestamp);
  // Permitir actualización si el schedule tiene createdBy y coincide, o si no tiene createdBy (schedules antiguos)
  // Si no tiene createdBy, establecerlo en la primera actualización
  allow update: if isAuth() && (
    // Caso 1: Schedule con createdBy existente - debe coincidir con el usuario
    (resource.data.createdBy != null && resource.data.createdBy == uid()) ||
    // Caso 2: Schedule sin createdBy (antiguo) - permitir actualización y establecer createdBy
    (!('createdBy' in resource.data) && request.resource.data.createdBy == uid())
  )
    && (!('nombre' in request.resource.data) || nonEmptyString('nombre'))
    && (!('weekStart' in request.resource.data) || nonEmptyString('weekStart'))
    && (!('semanaInicio' in request.resource.data) || nonEmptyString('semanaInicio'))
    && (!('semanaFin' in request.resource.data) || nonEmptyString('semanaFin'))
    && (!('assignments' in request.resource.data) || request.resource.data.assignments is map)
    && (!('modifiedBy' in request.resource.data) || isStringOrNull('modifiedBy'))
    && (!('modifiedByName' in request.resource.data) || isStringOrNull('modifiedByName'))
    && (!('completada' in request.resource.data) || request.resource.data.completada is bool)
    && (!('completadaPor' in request.resource.data) || request.resource.data.completadaPor is string || request.resource.data.completadaPor == null)
    && (!('completadaPorNombre' in request.resource.data) || request.resource.data.completadaPorNombre is string || request.resource.data.completadaPorNombre == null)
    && (!('completadaEn' in request.resource.data) || request.resource.data.completadaEn is timestamp || request.resource.data.completadaEn == null)
    && (!('updatedAt' in request.resource.data) || request.resource.data.updatedAt is timestamp)
    && unchanged('createdAt')
    && (
      // Si ya tiene createdBy, no debe cambiar
      (resource.data.createdBy != null && unchanged('createdBy')) ||
      // Si no tiene createdBy, debe establecerse al uid del usuario
      (!('createdBy' in resource.data) && request.resource.data.createdBy == uid())
    )
    && (!('createdByName' in request.resource.data) || isStringOrNull('createdByName'));
  // Permitir eliminación si tiene createdBy y coincide, o si no tiene createdBy (schedules antiguos)
  allow delete: if isAuth() && (
    (resource.data.createdBy != null && resource.data.createdBy == uid()) ||
    (!('createdBy' in resource.data))
  );
}

// Colección: apps/horarios/historial
match /apps/horarios/historial/{historialId} {
  allow read: if isAuth() && resource.data.createdBy == uid();
  allow create: if isAuth()
    && nonEmptyString('horarioId')
    && nonEmptyString('nombre')
    && nonEmptyString('semanaInicio')
    && nonEmptyString('semanaFin')
    && request.resource.data.assignments is map
    && (request.resource.data.accion == 'creado' || request.resource.data.accion == 'modificado')
    && isTs('createdAt')
    && nonEmptyString('createdBy')
    && request.resource.data.createdBy == uid()
    && isStringOrNull('createdByName')
    && (isBool('versionAnterior') || !('versionAnterior' in request.resource.data));
  allow update: if false; // Historial es inmutable
  allow delete: if isAuth() && resource.data.createdBy == uid();
}

// Colección: apps/horarios/config
match /apps/horarios/config/{configId} {
  // Cada usuario solo puede leer/editar su propia configuración (configId debe ser su uid)
  allow read: if isAuth() && configId == uid();
  allow create: if isAuth() && configId == uid();
  allow update: if isAuth() && configId == uid();
  allow delete: if false; // No permitir eliminar configuración
}

