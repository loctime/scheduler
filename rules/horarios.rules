// ========= HORARIOS SCHEDULER =========

// Colección: apps/horarios/users
match /apps/horarios/users/{userId} {
  // Permitir lectura:
  // - El usuario puede leer su propio documento
  // - El dueño puede leer documentos de usuarios invitados vinculados a sus invitaciones
  allow read: if isAuth() && (
    userId == uid()
    || (exists(/databases/$(db)/documents/apps/horarios/users/$(userId))
      && get(/databases/$(db)/documents/apps/horarios/users/$(userId)).data.role == 'invited'
      && get(/databases/$(db)/documents/apps/horarios/users/$(userId)).data.ownerId == uid())
  );
  // Crear: el usuario puede crear su propio documento
  allow create: if isAuth() && userId == uid();
  // Actualizar: el usuario puede actualizar su propio documento
  // Si el campo uid existe, no debe cambiar; si no existe, se puede agregar
  allow update: if isAuth() && userId == uid() && (
    !('uid' in resource.data) || 
    !('uid' in request.resource.data) || 
    request.resource.data.uid == resource.data.uid
  );
  // Eliminar: 
  // - El usuario puede eliminar su propio documento
  // - El dueño puede eliminar usuarios invitados vinculados a sus invitaciones
  allow delete: if isAuth() && (
    userId == uid()
    || (exists(/databases/$(db)/documents/apps/horarios/users/$(userId))
      && get(/databases/$(db)/documents/apps/horarios/users/$(userId)).data.role == 'invited'
      && get(/databases/$(db)/documents/apps/horarios/users/$(userId)).data.ownerId == uid())
  );
}

// Colección: apps/horarios/employees
match /apps/horarios/employees/{empleadoId} {
  // Permitir lectura pública (para página compartible)
  allow read: if true;
  // Crear: verificar que userId sea correcto
  allow create: if isAuth() && request.resource.data.userId == uid();
  // Actualizar: verificar propiedad y proteger userId
  allow update: if isAuth() && resource.data.userId == uid()
    && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId);
  // Eliminar: solo el dueño
  allow delete: if isAuth() && resource.data.userId == uid();
}

// Colección: apps/horarios/shifts
match /apps/horarios/shifts/{turnoId} {
  // Permitir lectura pública (para página compartible)
  allow read: if true;
  // Crear: verificar que userId sea correcto
  allow create: if isAuth() && request.resource.data.userId == uid();
  // Actualizar: verificar propiedad y proteger userId
  allow update: if isAuth() && resource.data.userId == uid()
    && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId);
  // Eliminar: solo el dueño
  allow delete: if isAuth() && resource.data.userId == uid();
}

// Colección: apps/horarios/schedules
match /apps/horarios/schedules/{horarioId} {
  // Permitir lectura pública (para página compartible)
  allow read: if true;
  // Crear: verificar que createdBy sea correcto
  allow create: if isAuth() && request.resource.data.createdBy == uid();
  // Actualizar: verificar propiedad y proteger createdBy
  allow update: if isAuth() && resource.data.createdBy == uid()
    && (!('createdBy' in request.resource.data) || request.resource.data.createdBy == resource.data.createdBy);
  // Eliminar: solo el dueño
  allow delete: if isAuth() && resource.data.createdBy == uid();
}

// Colección: apps/horarios/historial
match /apps/horarios/historial/{historialId} {
  // Solo el dueño puede leer
  allow read: if isAuth() && resource.data.createdBy == uid();
  // Crear: verificar que createdBy sea correcto
  allow create: if isAuth() && request.resource.data.createdBy == uid();
  // Historial es inmutable
  allow update: if false;
  // Eliminar: solo el dueño
  allow delete: if isAuth() && resource.data.createdBy == uid();
}

// Colección: apps/horarios/config
match /apps/horarios/config/{configId} {
  // Permitir lectura pública (para página compartible)
  allow read: if true;
  // Solo el usuario puede editar su propia configuración (configId debe ser su uid)
  allow write: if isAuth() && configId == uid();
  // No permitir eliminar configuración
  allow delete: if false;
}

// Colección: apps/horarios/invitaciones
match /apps/horarios/invitaciones/{invitacionId} {
  // Permitir lectura sin autenticación para validar tokens en registro
  // Esto es necesario porque el registro se hace sin autenticación
  allow read: if true;
  // El dueño puede crear invitaciones
  allow create: if isAuth() && request.resource.data.ownerId == uid();
  // Actualizar:
  // - El dueño puede actualizar cualquier cosa
  // - Cualquier usuario autenticado puede marcar como usada (protegiendo campos sensibles)
  allow update: if isAuth() && (
    // El ownerId puede hacer cualquier actualización
    resource.data.ownerId == uid()
    // O cualquier usuario autenticado puede marcar como usada
    || (
      // Solo si la invitación no está ya usada
      (resource.data.usado == null || resource.data.usado == false || !('usado' in resource.data))
      // Proteger campos sensibles (no se pueden cambiar)
      && (!('ownerId' in request.resource.data) || request.resource.data.ownerId == resource.data.ownerId)
      && (!('token' in request.resource.data) || request.resource.data.token == resource.data.token)
      && (!('activo' in request.resource.data) || request.resource.data.activo == resource.data.activo)
    )
  );
  // Eliminar: solo el dueño puede eliminar sus invitaciones
  allow delete: if isAuth() && resource.data.ownerId == uid();
}

// Colección: apps/horarios/pedidos
match /apps/horarios/pedidos/{pedidoId} {
  // Permitir lectura si es el dueño O si es un usuario invitado del dueño O si no hay autenticación
  allow read: if (isAuth() && resource.data.userId == uid()) 
    || (isAuth() && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role == 'invited'
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId == resource.data.userId)
    || !isAuth();
  // Crear: verificar que userId sea correcto (solo dueños pueden crear)
  allow create: if isAuth() && request.resource.data.userId == uid()
    && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
    && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role != 'invited';
  // Actualizar: 
  // - Si está autenticado como dueño: verificar propiedad y proteger userId
  // - Si está autenticado como invitado: permitir actualizar si el pedido pertenece a su ownerId
  // - Si NO está autenticado: permitir actualizar desde enlace público
  //   - Permitir cambiar de "creado" o "completado" a "enviado" (confirmación desde enlace público)
  //   - NO permitir cambiar si ya está "enviado" o "recibido" (solo el dueño puede hacerlo)
  //   - Solo se actualizan campos específicos (estado, remitoEnvioId, fechaEnvio, updatedAt)
  //   - sin modificar userId ni otros campos sensibles
  allow update: if (isAuth() && resource.data.userId == uid()
    && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId))
    || (isAuth() 
      && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role == 'invited'
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId == resource.data.userId
      && (
        // Permitir si el estado actual es "creado", "completado", null o undefined
        // (NO permitir si ya está "enviado" o "recibido")
        (!('estado' in resource.data)
        || resource.data.estado == null
        || resource.data.estado == "creado"
        || resource.data.estado == "completado")
      )
      && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId))
    || (!isAuth() 
      && (
        // Permitir si el estado actual es "creado", "completado", null o undefined
        // (NO permitir si ya está "enviado" o "recibido")
        (!('estado' in resource.data)
        || resource.data.estado == null
        || resource.data.estado == "creado"
        || resource.data.estado == "completado")
      )
      && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId)
      // Solo permitir actualizar campos específicos: estado, remitoEnvioId, fechaEnvio, updatedAt
      && (!('nombre' in request.resource.data) || request.resource.data.nombre == resource.data.nombre)
      && (!('stockMinimoDefault' in request.resource.data) || request.resource.data.stockMinimoDefault == resource.data.stockMinimoDefault)
      && (!('formatoSalida' in request.resource.data) || request.resource.data.formatoSalida == resource.data.formatoSalida)
      && (!('mensajePrevio' in request.resource.data) || request.resource.data.mensajePrevio == resource.data.mensajePrevio)
      && (!('origenDefault' in request.resource.data) || request.resource.data.origenDefault == resource.data.origenDefault)
      && (!('destinoDefault' in request.resource.data) || request.resource.data.destinoDefault == resource.data.destinoDefault)
      && (!('fechaRecepcion' in request.resource.data) || request.resource.data.fechaRecepcion == resource.data.fechaRecepcion)
      && (!('createdAt' in request.resource.data) || request.resource.data.createdAt == resource.data.createdAt));
  // Eliminar: solo el dueño (no invitados)
  allow delete: if isAuth() && resource.data.userId == uid()
    && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
    && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role != 'invited';
}

// Colección: apps/horarios/products
match /apps/horarios/products/{productoId} {
  // Permitir lectura si es el dueño O si es un usuario invitado del dueño O si no hay autenticación
  allow read: if (isAuth() && resource.data.userId == uid()) 
    || (isAuth() && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role == 'invited'
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId == resource.data.userId)
    || !isAuth();
  // Crear: verificar que userId sea correcto (invitados pueden crear productos con ownerId)
  allow create: if isAuth() && (
    (request.resource.data.userId == uid() && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role != 'invited')
    || (exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role == 'invited'
      && request.resource.data.userId == get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId)
  );
  // Actualizar: verificar propiedad y proteger userId (invitados pueden actualizar productos del ownerId)
  allow update: if (isAuth() && resource.data.userId == uid()
    && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId))
    || (isAuth() 
      && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role == 'invited'
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId == resource.data.userId
      && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId));
  // Eliminar: solo el dueño (no invitados)
  allow delete: if isAuth() && resource.data.userId == uid()
    && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
    && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role != 'invited';
}

// Colección: apps/horarios/stock_movimientos
match /apps/horarios/stock_movimientos/{movimientoId} {
  // Permitir lectura si es el dueño O si es un usuario invitado del dueño
  allow read: if isAuth() && (
    resource.data.userId == uid()
    || (exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role == 'invited'
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId == resource.data.userId)
  );
  // Crear: verificar que userId sea correcto (permite usuarios invitados crear con ownerId)
  allow create: if isAuth() && (
    request.resource.data.userId == uid()
    || (exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role == 'invited'
      && request.resource.data.userId == get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId)
  );
  // Actualizar: verificar propiedad y proteger userId (los movimientos generalmente son inmutables)
  allow update: if isAuth() && resource.data.userId == uid()
    && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId);
  // Eliminar: solo el dueño
  allow delete: if isAuth() && resource.data.userId == uid();
}

// Colección: apps/horarios/stock_actual
match /apps/horarios/stock_actual/{stockId} {
  // Helper para verificar si el usuario es invitado
  function isInvitedUser() {
    return isAuth() 
      && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role == 'invited';
  }
  // Helper para obtener el ownerId del usuario invitado
  function getOwnerId() {
    return isInvitedUser() 
      ? get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId
      : null;
  }
  
  // Permitir lectura si es el dueño O si es un usuario invitado del dueño
  allow read: if isAuth() && (
    (resource.data != null && resource.data.userId == uid())
    || stockId.matches(uid() + '_.*')
    || (resource.data != null && isInvitedUser() && getOwnerId() != null && resource.data.userId == getOwnerId())
    || (isInvitedUser() && getOwnerId() != null && stockId.matches(getOwnerId() + '_.*'))
  );
  
  // Crear: verificar que userId sea correcto (permite usuarios invitados crear con ownerId)
  // Simplificado para permitir creación si el userId en el documento coincide con uid o ownerId
  allow create: if isAuth() && (
    // Usuario normal: userId debe coincidir con su uid
    (request.resource.data.userId == uid() || stockId.matches(uid() + '_.*'))
    // Usuario invitado: userId debe coincidir con su ownerId
    || (isInvitedUser() 
      && getOwnerId() != null 
      && (request.resource.data.userId == getOwnerId() || stockId.matches(getOwnerId() + '_.*')))
  );
  
  // Actualizar: verificar propiedad y proteger userId (permite usuarios invitados actualizar con ownerId)
  allow update: if isAuth() && (
    (resource.data != null && resource.data.userId == uid())
    || stockId.matches(uid() + '_.*')
    || (resource.data != null && isInvitedUser() && getOwnerId() != null && resource.data.userId == getOwnerId())
    || (isInvitedUser() && getOwnerId() != null && stockId.matches(getOwnerId() + '_.*'))
  ) && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId);
  
  // Eliminar: solo el dueño (permite usuarios invitados eliminar con ownerId)
  allow delete: if isAuth() && (
    (resource.data != null && resource.data.userId == uid())
    || stockId.matches(uid() + '_.*')
    || (resource.data != null && isInvitedUser() && getOwnerId() != null && resource.data.userId == getOwnerId())
    || (isInvitedUser() && getOwnerId() != null && stockId.matches(getOwnerId() + '_.*'))
  );
}

// Colección: apps/horarios/remitos
match /apps/horarios/remitos/{remitoId} {
  // Permitir lectura si es el dueño O si es un usuario invitado del dueño O si pertenece a un pedido del usuario
  allow read: if isAuth() && (
    resource.data.userId == uid()
    || (exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role == 'invited'
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId == resource.data.userId)
    || (resource.data.pedidoId != null
      && exists(/databases/$(db)/documents/apps/horarios/pedidos/$(resource.data.pedidoId))
      && get(/databases/$(db)/documents/apps/horarios/pedidos/$(resource.data.pedidoId)).data.userId == uid())
  );
  // Crear: 
  // - Si está autenticado: verificar que userId sea correcto (permite usuarios invitados crear con ownerId)
  // - Si NO está autenticado: permitir solo si el pedido existe y el userId coincide
  //   (la aplicación controla que el pedido esté en estado válido antes de crear el remito)
  allow create: if (isAuth() && (
    request.resource.data.userId == uid()
    || (exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role == 'invited'
      && request.resource.data.userId == get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId)
  ))
    || (!isAuth() 
      && request.resource.data.pedidoId != null
      && exists(/databases/$(db)/documents/apps/horarios/pedidos/$(request.resource.data.pedidoId))
      && request.resource.data.userId != null
      && request.resource.data.userId == get(/databases/$(db)/documents/apps/horarios/pedidos/$(request.resource.data.pedidoId)).data.userId);
  // Actualizar: verificar propiedad y proteger userId
  allow update: if isAuth() && resource.data.userId == uid()
    && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId);
  // Eliminar: solo el dueño (por userId o por pedido asociado)
  allow delete: if isAuth() && (
    resource.data.userId == uid()
    || (resource.data.pedidoId != null
      && exists(/databases/$(db)/documents/apps/horarios/pedidos/$(resource.data.pedidoId))
      && get(/databases/$(db)/documents/apps/horarios/pedidos/$(resource.data.pedidoId)).data.userId == uid())
  );
}

// Colección: apps/horarios/recepciones
match /apps/horarios/recepciones/{recepcionId} {
  // Solo el dueño puede leer sus recepciones
  allow read: if isAuth() && resource.data.userId == uid();
  // Crear: verificar que userId sea correcto
  allow create: if isAuth() && request.resource.data.userId == uid();
  // Actualizar: verificar propiedad y proteger userId
  allow update: if isAuth() && resource.data.userId == uid()
    && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId);
  // Eliminar: solo el dueño
  allow delete: if isAuth() && resource.data.userId == uid();
}

// Colección: apps/horarios/enlaces_publicos
match /apps/horarios/enlaces_publicos/{enlaceId} {
  // Helper para verificar si el usuario es invitado
  function isInvitedUser() {
    return isAuth() 
      && exists(/databases/$(db)/documents/apps/horarios/users/$(uid()))
      && get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.role == 'invited';
  }
  // Helper para obtener el ownerId del usuario invitado
  function getOwnerId() {
    return isInvitedUser() 
      ? get(/databases/$(db)/documents/apps/horarios/users/$(uid())).data.ownerId
      : null;
  }
  
  // Permitir lectura pública (para que la fábrica pueda acceder sin login)
  allow read: if true;
  // Crear: verificar que userId sea correcto (permite usuarios invitados crear con ownerId)
  allow create: if isAuth() && (
    request.resource.data.userId == uid()
    || (isInvitedUser() && getOwnerId() != null && request.resource.data.userId == getOwnerId())
  );
  // Actualizar: 
  // - Si está autenticado: verificar propiedad y proteger userId (permite usuarios invitados actualizar con ownerId)
  // - Si NO está autenticado: permitir actualizar cuando está activo
  //   - Proteger campos sensibles (userId, pedidoId, createdAt)
  //   - Permitir actualizar productosDisponibles, fechaAcceso
  //   - Permitir desactivar solo si el pedido está enviado
  allow update: if (isAuth() && (
    resource.data.userId == uid()
    || (isInvitedUser() && getOwnerId() != null && resource.data.userId == getOwnerId())
  ) && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId))
    || (!isAuth() 
      && resource.data.activo == true
      // Proteger campos sensibles
      && (!('userId' in request.resource.data) || request.resource.data.userId == resource.data.userId)
      && (!('pedidoId' in request.resource.data) || request.resource.data.pedidoId == resource.data.pedidoId)
      && (!('createdAt' in request.resource.data) || request.resource.data.createdAt == resource.data.createdAt)
      && (
        // Caso 1: No se modifica activo o no está en request - permitir actualizar
        (!('activo' in request.resource.data) || request.resource.data.activo == true)
        // Caso 2: Se intenta desactivar - solo si el pedido está enviado
        || (request.resource.data.activo == false
          && exists(/databases/$(db)/documents/apps/horarios/pedidos/$(resource.data.pedidoId))
          && get(/databases/$(db)/documents/apps/horarios/pedidos/$(resource.data.pedidoId)).data.estado == "enviado")
      ));
  // Eliminar: solo el dueño (permite usuarios invitados eliminar con ownerId)
  allow delete: if isAuth() && (
    resource.data.userId == uid()
    || (isInvitedUser() && getOwnerId() != null && resource.data.userId == getOwnerId())
  );
}
